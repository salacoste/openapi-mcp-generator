# Story 4.5: Multi-Scheme Security Handling - Brownfield Addition

**Epic:** Epic 4: Authentication & Security Handlers

---

## User Story

**As a** generated MCP server,
**I want** to support APIs that use multiple authentication schemes,
**So that** I can handle complex security configurations.

---

## Story Context

**Existing System Integration:**
- Integrates with: All auth handlers (4.2-4.4), HTTP client (3.3), configuration (4.1)
- Technology: Multi-auth coordination, OpenAPI security requirements
- Follows pattern: Request interceptor orchestration
- Touch points: HTTP client interceptor, security scheme parsing

**Epic Context:**
Coordinates multiple authentication schemes in a single request. Supports AND logic (multiple schemes required) and OR logic (alternative schemes).

---

## Acceptance Criteria

### Functional Requirements

1. **Multi-Auth Module:** Create `auth/multi-scheme.ts.hbs` for auth composition
2. **AND Logic:** Apply multiple auth schemes to single request (e.g., API Key + Bearer)
3. **OR Logic:** Support alternative auth schemes (user chooses one)
4. **Operation-Level Auth:** Override global auth with operation-specific requirements
5. **Auth Composition:** Chain multiple auth handlers in interceptor
6. **Validation:** Ensure all required auth schemes have credentials
7. **Documentation:** README explains multi-scheme requirements
8. **Error Handling:** Clear messages for missing multi-auth credentials
9. **Priority:** Apply auth schemes in defined order (deterministic)
10. **Template Logic:** Generate appropriate code based on security combinations

### Integration Requirements

11. **Security Parsing:** Extract global and operation-level security from OpenAPI
12. **HTTP Client:** Orchestrate all auth handlers in correct order
13. **Configuration:** Validate all required credentials present

### Quality Requirements

14. **Testing:** AND logic, OR logic, operation-level override, validation (≥80%)
15. **Documentation:** Multi-scheme examples, configuration guide
16. **Code Quality:** Type-safe, deterministic, <10ms latency

---

## Technical Notes

```typescript
// auth/multi-scheme.ts.hbs
export function applyMultiSchemeAuth(
  config: InternalAxiosRequestConfig,
  serverConfig: ServerConfig,
  operation: Operation
): InternalAxiosRequestConfig {
  const securityRequirements = operation.security || globalSecurity;

  for (const requirement of securityRequirements) {
    {{#if hasApiKey}}
    if (requirement.apiKey) {
      config = addApiKeyAuth(config, serverConfig);
    }
    {{/if}}
    {{#if hasBearerToken}}
    if (requirement.bearer) {
      config = addBearerAuth(config, serverConfig);
    }
    {{/if}}
    {{#if hasBasicAuth}}
    if (requirement.basic) {
      config = addBasicAuth(config, serverConfig);
    }
    {{/if}}
  }

  return config;
}
```

---

## Definition of Done

- [ ] Multi-auth module created
- [ ] AND logic working (multiple schemes applied)
- [ ] OR logic supported (alternative schemes)
- [ ] Operation-level auth overrides global
- [ ] Validation for all required schemes
- [ ] Documentation explains multi-scheme setup
- [ ] All tests pass (≥80%)

---

## Success Criteria

1. ✅ Multiple auth schemes applied correctly
2. ✅ Operation-level overrides work
3. ✅ Validation catches missing credentials
4. ✅ Documentation clear
5. ✅ Tests pass 100%
6. ✅ Ready for Security Detection (Story 4.6)

---

**Story Created:** 2025-01-04  
**Epic:** Epic 4  
**Story Number:** 4.5  
**Estimated Effort:** 4-5 hours
