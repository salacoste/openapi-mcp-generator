# Story 2.1: OpenAPI Document Loading and Format Detection

**Epic:** Epic 2: OpenAPI Parsing & Validation Engine

---

## Status

**Draft**

---

## Story

**As a** CLI user,
**I want** the tool to automatically detect and load OpenAPI documents in JSON or YAML format,
**so that** I don't have to manually specify the file format.

---

## Acceptance Criteria

### Functional Requirements

1. **Parser Package Creation**
   - Create `packages/parser/` directory with proper TypeScript configuration
   - Initialize package.json with required dependencies (`js-yaml`, `@types/js-yaml`)
   - Create `src/loader.ts` module with document loading functionality
   - Export `loadOpenAPIDocument(filePath: string)` function

2. **Format Detection**
   - Automatically detect file format based on extension (`.json`, `.yaml`, `.yml`)
   - Return parsed JavaScript object from YAML or JSON input
   - Handle file extensions case-insensitively (`.JSON`, `.Yaml`, `.YML`)

3. **Document Parsing**
   - Parse YAML files using `js-yaml` library with proper error handling
   - Parse JSON files using native `JSON.parse()` with validation
   - Return consistent object structure regardless of input format
   - Preserve OpenAPI document structure exactly as specified

4. **File Handling**
   - Accept both absolute and relative file paths
   - Validate file existence before attempting to read
   - Enforce UTF-8 encoding for all document loading
   - Handle file read errors with descriptive messages

5. **Error Messages**
   - File not found: Display full path and suggest checking path
   - Invalid JSON: Show line number and character position of error
   - Invalid YAML: Show line number and parsing error details
   - Permission errors: Clear message about file access issues

### Integration Requirements

6. **CLI Integration**
   - Integrate with existing CLI `generate` command from Epic 1
   - CLI calls `loadOpenAPIDocument()` with user-provided file path
   - Loading errors are caught and formatted by CLI error handler (Story 1.7)
   - Verbose mode logs file path, detected format, document size in bytes

7. **File System Utilities**
   - Use file system utilities from Story 1.4 where applicable
   - Maintain consistent error handling approach from Epic 1
   - Follow existing logging patterns from Story 1.7

8. **Existing Functionality**
   - CLI command parsing and validation continues to work unchanged
   - Error handling system from Story 1.7 handles loader errors correctly
   - Verbose logging maintains consistent format with other CLI operations

### Quality Requirements

9. **Testing Coverage**
   - Unit tests for successful JSON loading
   - Unit tests for successful YAML loading
   - Unit tests for file not found error
   - Unit tests for invalid JSON syntax
   - Unit tests for invalid YAML syntax
   - Unit tests for various file extensions (`.json`, `.yaml`, `.yml`, mixed case)
   - Unit tests for absolute and relative path handling
   - Unit tests for UTF-8 encoding enforcement
   - Integration test with CLI command from Epic 1
   - Test coverage ≥80% for loader module

10. **Documentation Updates**
    - Update `packages/parser/README.md` with loader API documentation
    - Document supported file formats and extensions
    - Add JSDoc comments to `loadOpenAPIDocument` function
    - Include usage examples in parser package documentation

11. **Code Quality**
    - Follow existing TypeScript strict mode configuration
    - Pass ESLint and Prettier checks
    - No regression in existing Epic 1 functionality verified
    - TypeScript compilation successful with no errors

---

## Tasks / Subtasks

- [ ] **Task 1: Create Parser Package Structure** (AC: 1)
  - [ ] Create `packages/parser/` directory
  - [ ] Initialize `package.json` with name `@openapi-to-mcp/parser`, version `0.1.0`, type `module`
  - [ ] Add dependencies: `js-yaml@^4.1.0`
  - [ ] Add devDependencies: `@types/js-yaml@^4.0.5`
  - [ ] Create `tsconfig.json` extending root config with `outDir: "./dist"`, `rootDir: "./src"`
  - [ ] Create `src/` directory
  - [ ] Create `__tests__/` or `src/__tests__/` directory for tests
  - [ ] Create `README.md` placeholder

- [ ] **Task 2: Create Type Definitions** (AC: 1, 3)
  - [ ] Create `src/types.ts` with `OpenAPIDocument` type (or import from `openapi-types`)
  - [ ] Define `LoaderOptions` interface if needed
  - [ ] Define `LoaderResult` return type

- [ ] **Task 3: Create Custom Error Classes** (AC: 5, 7)
  - [ ] Create `src/errors.ts`
  - [ ] Define `FileSystemError` class (or import from shared package)
  - [ ] Define `ParseError` class with line number and position properties
  - [ ] Ensure error classes extend base Error with proper stack traces

- [ ] **Task 4: Implement loadOpenAPIDocument Function** (AC: 1, 2, 3, 4)
  - [ ] Create `src/loader.ts`
  - [ ] Implement `loadOpenAPIDocument(filePath: string): Promise<OpenAPIDocument>` signature
  - [ ] Add JSDoc comments with usage examples
  - [ ] Implement file existence validation using `fs.existsSync()` or `fs.access()`
  - [ ] Throw `FileSystemError` with full path if file not found
  - [ ] Normalize file path using `path.resolve()` for security
  - [ ] Implement format detection based on file extension (case-insensitive)
  - [ ] Read file content with UTF-8 encoding using `fs.readFile()`
  - [ ] Parse JSON files with `JSON.parse()` and wrap errors in `ParseError`
  - [ ] Parse YAML files with `js-yaml.load()` and wrap errors in `ParseError`
  - [ ] Return consistent object structure regardless of format
  - [ ] Handle permission errors with descriptive messages

- [ ] **Task 5: Implement Error Handling** (AC: 5, 7)
  - [ ] Catch file not found errors and format with full path
  - [ ] Catch JSON parsing errors and extract line/column from error message
  - [ ] Catch YAML parsing errors and extract line number from `js-yaml` error
  - [ ] Catch permission errors and provide clear message
  - [ ] Ensure all errors include suggested fixes for user

- [ ] **Task 6: Implement Security Validations** (AC: 4)
  - [ ] Validate file paths using `path.resolve()` to prevent traversal attacks
  - [ ] Ensure file path is within expected boundaries (optional, based on requirements)
  - [ ] Validate UTF-8 encoding enforcement

- [ ] **Task 7: Create Public API Export** (AC: 1)
  - [ ] Create `src/index.ts` as barrel export
  - [ ] Export `loadOpenAPIDocument` function
  - [ ] Export types from `types.ts`
  - [ ] Export custom errors from `errors.ts`

- [ ] **Task 8: Write Unit Tests** (AC: 9)
  - [ ] Create test file `src/loader.test.ts` or `__tests__/loader.test.ts`
  - [ ] Write test: successful JSON loading with valid OpenAPI JSON file
  - [ ] Write test: successful YAML loading with valid OpenAPI YAML file
  - [ ] Write test: file not found error with non-existent path
  - [ ] Write test: invalid JSON syntax error with malformed JSON
  - [ ] Write test: invalid YAML syntax error with malformed YAML
  - [ ] Write test: case-insensitive extension handling (`.JSON`, `.Yaml`, `.YML`)
  - [ ] Write test: absolute path handling
  - [ ] Write test: relative path handling
  - [ ] Write test: UTF-8 encoding enforcement
  - [ ] Create test fixtures in `__tests__/fixtures/` with sample valid/invalid files
  - [ ] Verify test coverage ≥80% using Vitest coverage report

- [ ] **Task 9: CLI Integration** (AC: 6, 8)
  - [ ] Update `packages/cli/src/commands/generate.ts` to import `loadOpenAPIDocument`
  - [ ] Call `loadOpenAPIDocument()` with user-provided file path in generate command
  - [ ] Integrate with error handler from Story 1.7 to catch and format loader errors
  - [ ] Add verbose logging for file path, detected format, document size
  - [ ] Test integration manually with sample OpenAPI files

- [ ] **Task 10: Write Integration Tests** (AC: 9)
  - [ ] Create integration test in `tests/integration/` or package `__tests__/integration/`
  - [ ] Test CLI command with valid OpenAPI file (JSON and YAML)
  - [ ] Verify CLI error handling for invalid files
  - [ ] Verify verbose mode logging output

- [ ] **Task 11: Documentation** (AC: 10)
  - [ ] Create `packages/parser/README.md` with package overview
  - [ ] Document `loadOpenAPIDocument()` API with signature and examples
  - [ ] Document supported file formats: JSON (`.json`), YAML (`.yaml`, `.yml`)
  - [ ] Document error handling behavior
  - [ ] Add usage examples showing both JSON and YAML loading

- [ ] **Task 12: Code Quality Verification** (AC: 11)
  - [ ] Run TypeScript compiler (`tsc --noEmit`) and fix any errors
  - [ ] Run ESLint (`pnpm lint`) and fix any violations
  - [ ] Run Prettier (`pnpm format`) to ensure consistent formatting
  - [ ] Run all tests (`pnpm test`) and verify ≥80% coverage
  - [ ] Verify no regression in Epic 1 functionality by running existing tests

- [ ] **Task 13: Final Validation** (AC: 6, 8, 11)
  - [ ] Test with sample OpenAPI files from `examples/` directory
  - [ ] Verify performance: file loading <500ms for files <1MB
  - [ ] Test edge cases: empty files, very large files, files with BOM
  - [ ] Verify all acceptance criteria are met
  - [ ] Update story status to "Review"

---

## Dev Notes

### Project Context

This story creates the **parser package** (`packages/parser/`) as the first story of Epic 2. It establishes the foundation for all subsequent parsing, validation, and transformation operations. The parser package integrates with the CLI package from Epic 1.

**Key Integration Points:**
- CLI `generate` command (Epic 1, Story 1.3) consumes the loader
- Error handling system (Epic 1, Story 1.7) formats loader errors
- File system utilities (Epic 1, Story 1.4) may be used for file operations
- Logging system (Epic 1, Story 1.7) for verbose mode output

### Source Tree Structure

```
packages/parser/
├── src/
│   ├── index.ts                # Public API: exports loadOpenAPIDocument, types, errors
│   ├── loader.ts               # Main loader implementation
│   ├── types.ts                # TypeScript type definitions
│   └── errors.ts               # Custom error classes
├── __tests__/                  # Test directory (or src/__tests__/)
│   ├── loader.test.ts          # Unit tests for loader
│   ├── fixtures/               # Test fixtures
│   │   ├── valid/
│   │   │   ├── petstore.json   # Valid OpenAPI JSON
│   │   │   └── petstore.yaml   # Valid OpenAPI YAML
│   │   └── invalid/
│   │       ├── malformed.json  # Invalid JSON syntax
│   │       └── malformed.yaml  # Invalid YAML syntax
│   └── integration/            # Integration tests (optional)
├── dist/                       # Build output (gitignored)
│   ├── index.js
│   ├── index.d.ts
│   └── index.d.ts.map
├── package.json                # Package configuration
├── tsconfig.json               # TypeScript config (extends root)
├── vitest.config.ts            # Vitest config (optional, can use root)
└── README.md                   # Package documentation
```

### Technology Stack

**Runtime & Language:**
- Node.js 20.11.0 LTS (minimum: ≥18.0.0)
- TypeScript 5.3.3 with strict mode enabled
- ESM module system (type: "module" in package.json)

**Dependencies:**
- `js-yaml@^4.1.0` - YAML parsing library (de-facto standard)
- `@types/js-yaml@^4.0.5` - TypeScript type definitions for js-yaml

**Optional Dependencies (if needed):**
- `openapi-types@12.1.3` - TypeScript types for OpenAPI 3.0 (for OpenAPIDocument type)

**Development Dependencies:**
- Vitest 1.2.0 (testing framework, configured at root)
- TypeScript 5.3.3 (configured at root)
- ESLint 8.56.0 (configured at root)
- Prettier 3.2.4 (configured at root)

### Package Configuration

**package.json:**
```json
{
  "name": "@openapi-to-mcp/parser",
  "version": "0.1.0",
  "description": "OpenAPI 3.0 parser with validation and normalization",
  "type": "module",
  "main": "./dist/index.js",
  "types": "./dist/index.d.ts",
  "exports": {
    ".": {
      "types": "./dist/index.d.ts",
      "import": "./dist/index.js"
    }
  },
  "scripts": {
    "build": "tsup src/index.ts --format esm --dts",
    "test": "vitest run",
    "test:watch": "vitest",
    "test:coverage": "vitest run --coverage",
    "lint": "eslint src",
    "format": "prettier --write src"
  },
  "dependencies": {
    "js-yaml": "^4.1.0"
  },
  "devDependencies": {
    "@types/js-yaml": "^4.0.5",
    "openapi-types": "^12.1.3"
  },
  "keywords": ["openapi", "parser", "yaml", "json"],
  "author": "",
  "license": "MIT"
}
```

**tsconfig.json:**
```json
{
  "extends": "../../tsconfig.json",
  "compilerOptions": {
    "outDir": "./dist",
    "rootDir": "./src"
  },
  "include": ["src"],
  "exclude": ["node_modules", "dist", "__tests__"]
}
```

### Implementation Details

**Loader Function Signature:**
```typescript
// src/loader.ts
import type { OpenAPIObject } from 'openapi-types';

export async function loadOpenAPIDocument(
  filePath: string
): Promise<OpenAPIObject> {
  // Implementation
}
```

**Error Handling Pattern (from Epic 1, Story 1.7):**
```typescript
// src/errors.ts
export class FileSystemError extends Error {
  constructor(message: string, public path: string) {
    super(message);
    this.name = 'FileSystemError';
  }
}

export class ParseError extends Error {
  constructor(
    message: string,
    public line?: number,
    public column?: number
  ) {
    super(message);
    this.name = 'ParseError';
  }
}
```

**Format Detection Logic:**
```typescript
function detectFormat(filePath: string): 'json' | 'yaml' {
  const ext = path.extname(filePath).toLowerCase();
  if (ext === '.json') return 'json';
  if (ext === '.yaml' || ext === '.yml') return 'yaml';
  throw new Error(`Unsupported file format: ${ext}`);
}
```

**Security: Path Validation:**
```typescript
import path from 'node:path';

function validateFilePath(filePath: string): string {
  // Resolve to absolute path to prevent traversal
  const resolvedPath = path.resolve(filePath);

  // Additional validation can be added here if needed
  // e.g., ensure path is within allowed directories

  return resolvedPath;
}
```

**YAML Parsing with js-yaml:**
```typescript
import yaml from 'js-yaml';
import fs from 'node:fs/promises';

try {
  const content = await fs.readFile(filePath, 'utf-8');
  const document = yaml.load(content);
  return document as OpenAPIObject;
} catch (error) {
  if (error instanceof yaml.YAMLException) {
    throw new ParseError(
      `Invalid YAML: ${error.message}`,
      error.mark?.line,
      error.mark?.column
    );
  }
  throw error;
}
```

**JSON Parsing:**
```typescript
try {
  const content = await fs.readFile(filePath, 'utf-8');
  return JSON.parse(content);
} catch (error) {
  if (error instanceof SyntaxError) {
    // Extract line/column from error message if possible
    const match = error.message.match(/position (\d+)/);
    throw new ParseError(`Invalid JSON: ${error.message}`);
  }
  throw error;
}
```

### CLI Integration

**In packages/cli/src/commands/generate.ts:**
```typescript
import { loadOpenAPIDocument } from '@openapi-to-mcp/parser';
import { FileSystemError, ParseError } from '@openapi-to-mcp/parser';

async function generateCommand(openApiPath: string, options: Options) {
  try {
    // Verbose logging
    if (options.verbose) {
      console.log(`Loading OpenAPI document from: ${openApiPath}`);
    }

    const document = await loadOpenAPIDocument(openApiPath);

    if (options.verbose) {
      const size = JSON.stringify(document).length;
      console.log(`Loaded OpenAPI document (${size} bytes)`);
    }

    // Continue with validation and generation...
  } catch (error) {
    if (error instanceof FileSystemError) {
      console.error(`Error: File not found: ${error.path}`);
      console.error('Please check the file path and try again.');
      process.exit(1);
    }
    if (error instanceof ParseError) {
      console.error(`Error: Failed to parse OpenAPI document`);
      console.error(error.message);
      if (error.line) {
        console.error(`  at line ${error.line}, column ${error.column || 0}`);
      }
      process.exit(1);
    }
    throw error; // Re-throw unexpected errors
  }
}
```

### Error Handling Integration

From Story 1.7, the CLI has custom error classes and formatting. The loader's errors should integrate seamlessly:

- `FileSystemError` - for file not found, permission errors
- `ParseError` - for JSON/YAML parsing errors

CLI error handler should catch these and format them with:
- Red color for errors (using chalk)
- Clear error type
- Descriptive message
- Suggested fix
- Exit code 1 for user errors

### Performance Requirements

- File loading must complete in **<500ms** for typical files (<1MB)
- For files >1MB, performance should still be reasonable (<2s)
- No memory leaks when loading multiple files sequentially

### Security Considerations

1. **Path Traversal Prevention:**
   - Use `path.resolve()` to normalize all paths
   - Never use user input directly in file system operations
   - Consider validating paths are within expected directories

2. **File Size Limits (future consideration):**
   - May want to add max file size validation
   - Prevent loading extremely large files that could cause memory issues

3. **Content Validation:**
   - Ensure UTF-8 encoding (reject binary files)
   - This story only loads and parses; validation happens in Story 2.2

### Edge Cases to Handle

1. **Empty files** - should fail with clear error
2. **Files with BOM (Byte Order Mark)** - should handle gracefully
3. **Files with mixed line endings** - should parse correctly
4. **Very large files (>10MB)** - should handle without memory issues
5. **Symlinked files** - should follow symlinks correctly
6. **Files with spaces in path** - should handle correctly
7. **Unicode file names** - should handle correctly

### Testing

**Test File Location:**
- Co-located: `src/loader.test.ts` OR
- Separate: `__tests__/loader.test.ts`

**Testing Framework:** Vitest 1.2.0 (configured at workspace root)

**Coverage Thresholds (from vitest.config.ts):**
- Lines: ≥80%
- Functions: ≥80%
- Branches: ≥75%
- Statements: ≥80%

**Test Fixtures:**
- Create `__tests__/fixtures/valid/` with sample valid OpenAPI files
- Create `__tests__/fixtures/invalid/` with malformed files
- Use real-world examples from `examples/` directory when possible

**Testing Patterns:**
```typescript
import { describe, it, expect } from 'vitest';
import { loadOpenAPIDocument } from './loader';
import { FileSystemError, ParseError } from './errors';

describe('loadOpenAPIDocument', () => {
  it('should load valid JSON OpenAPI file', async () => {
    const doc = await loadOpenAPIDocument('__tests__/fixtures/valid/petstore.json');
    expect(doc).toBeDefined();
    expect(doc.openapi).toMatch(/^3\.0\.\d+$/);
  });

  it('should throw FileSystemError for non-existent file', async () => {
    await expect(
      loadOpenAPIDocument('non-existent.json')
    ).rejects.toThrow(FileSystemError);
  });

  // ... more tests
});
```

**Integration Test:**
- Create test in `tests/integration/cli-loader.test.ts`
- Test CLI command execution with sample OpenAPI files
- Verify error handling and verbose logging

### Development Workflow

1. **Create package structure** (Task 1)
2. **Implement types and errors** (Tasks 2-3)
3. **Implement loader function** (Tasks 4-6)
4. **Create public API** (Task 7)
5. **Write unit tests** (Task 8)
6. **Integrate with CLI** (Task 9)
7. **Write integration tests** (Task 10)
8. **Write documentation** (Task 11)
9. **Quality verification** (Task 12)
10. **Final validation** (Task 13)

### Dependencies on Other Stories

**Completed (Epic 1):**
- Story 1.1: Monorepo structure and TypeScript configuration
- Story 1.3: CLI framework and command structure
- Story 1.4: File system utilities
- Story 1.6: Testing framework setup
- Story 1.7: Error handling and logging system

**Blocks:**
- Story 2.2: OpenAPI 3.0 Schema Validation (depends on this loader)
- All subsequent Epic 2 stories depend on this loader

### Constraints

- **No Breaking Changes:** Must not modify Epic 1 CLI command signatures
- **Dependency Versions:** Use exact versions from tech-stack.md
- **Format Support:** Only OpenAPI 3.0.x JSON/YAML (no Swagger 2.0)
- **Performance:** <500ms for typical files (<1MB)
- **Security:** Prevent directory traversal attacks

### Rollback Plan

If issues arise:
1. Parser package can be removed from `pnpm-workspace.yaml`
2. Remove import in CLI package
3. CLI shows "feature coming soon" message for generate command
4. No database or state changes to rollback

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-04 | 1.0 | Initial story creation | PO |
| 2025-01-04 | 2.0 | Restructured to match story template format | Sarah (PO) |

---

## Dev Agent Record

### Agent Model Used

_To be populated by dev agent during implementation_

### Debug Log References

_To be populated by dev agent during implementation_

### Completion Notes

_To be populated by dev agent during implementation_

### File List

_To be populated by dev agent during implementation_

---

## QA Results

_To be populated by QA agent after implementation_

---

**Story Created:** 2025-01-04
**Epic:** Epic 2: OpenAPI Parsing & Validation Engine
**Story Number:** 2.1
**Estimated Effort:** 4-6 hours
