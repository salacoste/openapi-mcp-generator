# Story 4.9: Authentication Integration Testing with Ozon Performance API - Brownfield Addition

**Epic:** Epic 4: Authentication & Security Handlers

---

## User Story

**As a** project stakeholder,
**I want** authentication validated against the Ozon Performance API,
**So that** I have confidence the auth implementation works with real APIs.

---

## Story Context

**Existing System Integration:**
- Integrates with: All Epic 4 stories (4.1-4.8), Ozon API OpenAPI spec, testing framework (1.6)
- Technology: Integration testing, authentication validation, Ozon API
- Follows pattern: End-to-end validation from Story 3.9
- Touch points: All auth handlers, HTTP client, configuration system

**Epic Context:**
Final validation story for Epic 4. Tests complete authentication pipeline with real Ozon Performance API specification and verifies all auth methods work correctly end-to-end.

---

## Acceptance Criteria

### Functional Requirements

1. **Integration Test Suite:** Create `auth-integration.test.ts` for auth validation
2. **Test Setup:** Generate MCP server from Ozon API OpenAPI specification
3. **Test Configuration:** Provide test API credentials via environment variables
4. **Auth Header Test:** Verify auth headers added correctly to requests
5. **API Call Test:** Make actual API request to Ozon API with authentication
6. **Response Validation:** Verify API returns 200 (not 401/403)
7. **Multi-Endpoint Test:** Validate auth works across different operations
8. **Negative Test:** Verify 401 error when auth credentials invalid
9. **Auth Scheme Detection:** Confirm correct auth type from OpenAPI
10. **Security Test:** Verify credentials not logged or exposed

### Integration Requirements

11. **CI Integration:** Tests run with mock credentials in CI (real in manual testing)
12. **Performance Test:** Auth interceptor adds <10ms overhead
13. **Documentation:** Authentication architecture diagram
14. **Regression Test:** Lock down auth implementation with snapshots
15. **User Guide:** Example Ozon API setup with step-by-step config

### Quality Requirements

16. **Testing Coverage:** All auth types, multi-auth, errors, security (≥80%)
17. **Real-World Validation:** Tested with actual Ozon API specification
18. **CI/CD:** Integration tests in GitHub Actions
19. **Performance:** Auth overhead within acceptable limits

---

## Technical Notes

**Integration Test:**
```typescript
// __tests__/integration/auth-integration.test.ts
describe('Authentication Integration (Ozon API)', () => {
  let outputDir: string;
  let client: AxiosInstance;

  beforeAll(async () => {
    outputDir = await mkdtemp(join(tmpdir(), 'mcp-auth-'));

    await generateMCPServer({
      openApiPath: 'fixtures/ozon-performance-api.yaml',
      outputDir,
      apiName: 'Ozon Performance API'
    });

    // Compile generated code
    execSync('npm run build', { cwd: outputDir });

    // Load generated HTTP client
    const clientModule = await import(join(outputDir, 'dist/http-client.js'));
    client = clientModule.createHttpClient({
      apiKey: 'test-client-id:test-api-key',
      baseURL: 'https://api-seller.ozon.ru',
      timeout: 30000
    });
  });

  it('should detect API Key authentication from OpenAPI', async () => {
    const config = await import(join(outputDir, 'dist/config.js'));
    const securityConfig = config.SECURITY_REQUIREMENTS;

    expect(securityConfig.hasApiKey).toBe(true);
    expect(securityConfig.required).toContain('ApiKeyAuth');
  });

  it('should add Client-Id and Api-Key headers', async () => {
    const mockRequest = jest.fn();
    client.interceptors.request.use((config) => {
      mockRequest(config);
      return config;
    });

    await client.get('/v1/test').catch(() => {}); // Ignore error

    expect(mockRequest).toHaveBeenCalled();
    const requestConfig = mockRequest.mock.calls[0][0];
    expect(requestConfig.headers['Client-Id']).toBe('test-client-id');
    expect(requestConfig.headers['Api-Key']).toBe('test-api-key');
  });

  it('should make successful API request with valid credentials', async () => {
    // Requires real Ozon API credentials (manual test only)
    if (!process.env.REAL_OZON_API_KEY) {
      return; // Skip in CI
    }

    const response = await client.get('/v1/posting/fbs/list', {
      params: { limit: 10 }
    });

    expect(response.status).toBe(200);
    expect(response.data).toBeDefined();
  });

  it('should return 401 with invalid credentials', async () => {
    const invalidClient = createHttpClient({
      apiKey: 'invalid:invalid',
      baseURL: 'https://api-seller.ozon.ru',
      timeout: 30000
    });

    await expect(
      invalidClient.get('/v1/posting/fbs/list')
    ).rejects.toThrow(/401/);
  });

  it('should not log API credentials', async () => {
    const consoleSpy = jest.spyOn(console, 'log');

    const config = loadConfig();

    expect(consoleSpy).not.toHaveBeenCalledWith(
      expect.stringContaining('test-api-key')
    );
  });

  it('should add minimal overhead (<10ms)', async () => {
    const start = Date.now();

    for (let i = 0; i < 100; i++) {
      const config = { headers: {} } as any;
      addApiKeyAuth(config, { apiKey: 'test:test' });
    }

    const duration = Date.now() - start;
    const avgPerRequest = duration / 100;

    expect(avgPerRequest).toBeLessThan(10);
  });
});
```

**CI Integration:**
```yaml
# .github/workflows/auth-tests.yml
name: Authentication Tests

on: [pull_request, push]

jobs:
  auth-tests:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20

      - run: npm ci
      - run: npm run test:auth

      # Manual test with real credentials (protected branch only)
      - name: Real API Test
        if: github.ref == 'refs/heads/main'
        env:
          REAL_OZON_API_KEY: ${{ secrets.OZON_API_KEY }}
        run: npm run test:auth:real
```

---

## Definition of Done

- [ ] Integration test suite created
- [ ] Ozon API test setup complete
- [ ] Auth header verification passing
- [ ] API call test working (with mocks)
- [ ] Multi-endpoint test passing
- [ ] Negative test (401) passing
- [ ] Auth detection test passing
- [ ] Security test (no logging) passing
- [ ] Performance test passing (<10ms)
- [ ] CI integration complete
- [ ] Documentation complete
- [ ] Architecture diagram added
- [ ] User guide for Ozon API
- [ ] All tests pass (≥80% coverage)
- [ ] **Epic 4 complete and validated**

---

## Success Criteria

1. ✅ Auth validated with real Ozon API specification
2. ✅ All auth headers added correctly
3. ✅ Real API calls successful (manual test)
4. ✅ Negative tests verify error handling
5. ✅ Credentials never logged
6. ✅ Performance within limits
7. ✅ Tests pass in CI 100%
8. ✅ Documentation complete
9. ✅ **Epic 4 production-ready**
10. ✅ Ready for Epic 5 (AI Optimization)

---

**Story Created:** 2025-01-04  
**Epic:** Epic 4: Authentication & Security Handlers  
**Story Number:** 4.9  
**Estimated Effort:** 5-6 hours  
**Epic Completion:** This story completes Epic 4
