# Story 4.7: Request Interceptor Architecture for Auth - Brownfield Addition

**Epic:** Epic 4: Authentication & Security Handlers

---

## User Story

**As a** generated MCP server,
**I want** a request interceptor architecture that applies authentication consistently,
**So that** all API requests are properly authenticated without code duplication.

---

## Story Context

**Existing System Integration:**
- Integrates with: HTTP client (3.3), all auth handlers (4.2-4.5), configuration (4.1)
- Technology: Axios request/response interceptors, auth orchestration
- Follows pattern: Interceptor chain pattern
- Touch points: HTTP client initialization, all request preprocessing

**Epic Context:**
Consolidates all auth handlers (Stories 4.2-4.5) into a unified interceptor architecture. Ensures consistent auth application across all requests with proper error handling and logging.

---

## Acceptance Criteria

### Functional Requirements

1. **Interceptor Module:** Create `interceptors/auth.ts.hbs` for auth orchestration
2. **Request Interceptor:** `authInterceptor` function applies all required auth
3. **Dynamic Auth Selection:** Use correct auth method for each operation
4. **Auth Caching:** Cache auth headers/params to avoid recomputation
5. **Registration:** Register during HTTP client initialization
6. **Error Handling:** Include operation name and auth type in errors
7. **Logging:** Log auth method used in debug mode (without credentials)
8. **Extensibility:** Support custom auth schemes via plugin architecture
9. **Order of Operations:** Apply auth after other request modifications
10. **Template Generation:** Generate interceptor based on detected auth schemes

### Integration Requirements

11. **HTTP Client:** Seamless integration with Story 3.3 Axios client
12. **Auth Handlers:** Orchestrate all handlers from Stories 4.2-4.5
13. **Configuration:** Use Story 4.1 config for auth credentials

### Quality Requirements

14. **Testing:** All auth types, multi-auth, caching, errors (≥80%)
15. **Documentation:** Interceptor architecture diagram, extension guide
16. **Performance:** <10ms overhead per request with caching

---

## Technical Notes

```typescript
// interceptors/auth.ts.hbs
import type { InternalAxiosRequestConfig } from 'axios';
import type { ServerConfig } from '../config.js';
import { addApiKeyAuth } from '../auth/api-key.js';
import { addBearerAuth } from '../auth/bearer.js';
import { addBasicAuth } from '../auth/basic.js';

/**
 * Request interceptor for authentication
 * Applies all required authentication schemes to outgoing requests
 */
export function createAuthInterceptor(config: ServerConfig) {
  return async (requestConfig: InternalAxiosRequestConfig): Promise<InternalAxiosRequestConfig> => {
    try {
      // Apply authentication schemes in order
      {{#if hasApiKey}}
      requestConfig = addApiKeyAuth(requestConfig, config);
      {{/if}}
      {{#if hasBearerToken}}
      requestConfig = addBearerAuth(requestConfig, config);
      {{/if}}
      {{#if hasBasicAuth}}
      requestConfig = addBasicAuth(requestConfig, config);
      {{/if}}

      // Log auth application (debug mode only)
      if (config.debug) {
        const authMethods = [];
        {{#if hasApiKey}}authMethods.push('API Key');{{/if}}
        {{#if hasBearerToken}}authMethods.push('Bearer Token');{{/if}}
        {{#if hasBasicAuth}}authMethods.push('Basic Auth');{{/if}}
        console.log(`✓ Authentication applied: ${authMethods.join(', ')}`);
      }

      return requestConfig;
    } catch (error) {
      console.error(`Authentication error for ${requestConfig.url}:`, error.message);
      throw error;
    }
  };
}

/**
 * Response interceptor for auth error handling
 * Handles 401/403 responses with helpful error messages
 */
export function createAuthErrorInterceptor() {
  return (error: any) => {
    if (error.response?.status === 401) {
      throw new Error(
        `Authentication failed (401 Unauthorized).\n` +
        `Please verify your credentials in the .env file.`
      );
    }

    if (error.response?.status === 403) {
      throw new Error(
        `Access forbidden (403 Forbidden).\n` +
        `Your credentials may not have sufficient permissions.`
      );
    }

    return Promise.reject(error);
  };
}
```

**HTTP Client Integration:**
```typescript
// http-client.ts.hbs
import { createAuthInterceptor, createAuthErrorInterceptor } from './interceptors/auth.js';

export function createHttpClient(config: ServerConfig): AxiosInstance {
  const client = axios.create({
    baseURL: config.baseURL,
    timeout: config.timeout
  });

  // Request interceptor for authentication
  client.interceptors.request.use(
    createAuthInterceptor(config),
    (error) => Promise.reject(error)
  );

  // Response interceptor for auth errors
  client.interceptors.response.use(
    (response) => response,
    createAuthErrorInterceptor()
  );

  return client;
}
```

---

## Definition of Done

- [ ] Interceptor module created
- [ ] Auth interceptor orchestrates all handlers
- [ ] Dynamic auth selection working
- [ ] Auth caching implemented
- [ ] Error handling comprehensive
- [ ] Debug logging (no credentials)
- [ ] HTTP client integration complete
- [ ] All tests pass (≥80%)
- [ ] Architecture documented

---

## Success Criteria

1. ✅ All auth schemes applied consistently
2. ✅ Interceptor handles multi-auth correctly
3. ✅ Caching reduces overhead
4. ✅ Clear errors for auth failures
5. ✅ Debug logging helpful (secure)
6. ✅ Tests pass 100%
7. ✅ Ready for Security Documentation (Story 4.8)

---

**Story Created:** 2025-01-04  
**Epic:** Epic 4  
**Story Number:** 4.7  
**Estimated Effort:** 4-5 hours
