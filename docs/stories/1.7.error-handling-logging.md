# Story 1.7: Error Handling and Logging System

## Status

Approved

## Story

**As a** user,
**I want** clear error messages when something goes wrong,
**so that** I can understand and fix issues quickly.

## Acceptance Criteria

1. Custom error classes created: `CLIError`, `FileSystemError`, `ValidationError`
2. Error messages include: error type, description, file/location context, suggested fix
3. Errors displayed in red color with clear formatting
4. Logging utility created with log levels: `error`, `warn`, `info`, `debug`
5. Default log level: `info` (shows important messages only)
6. `--verbose` flag enables `debug` level (shows detailed execution flow)
7. `--quiet` flag suppresses all output except errors
8. Stack traces shown only in `--verbose` mode
9. Exit codes: 0 for success, 1 for user errors, 2 for internal errors
10. All errors caught at top level with graceful handling (no unhandled promise rejections)

## Tasks / Subtasks

- [ ] Design error hierarchy and logging architecture (AC: 1, 4)
  - [ ] Review architecture error handling strategy from docs/architecture/architecture.md#error-handling-strategy
  - [ ] Design error class hierarchy extending BaseError
  - [ ] Design logging namespace strategy using `debug` library pattern
  - [ ] Document error categories and their appropriate exit codes
  - [ ] Plan integration points in CLI commands

- [ ] Create custom error classes (AC: 1, 2)
  - [ ] Create `packages/cli/src/errors/base-error.ts` with BaseError class
  - [ ] Implement CLIError class extending BaseError
  - [ ] Implement FileSystemError class extending BaseError
  - [ ] Implement ValidationError class extending BaseError
  - [ ] Add structured context fields: errorType, description, context, suggestedFix
  - [ ] Ensure all errors are serializable for logging
  - [ ] Add TypeScript type definitions for error contexts

- [ ] Implement error formatting utility (AC: 3)
  - [ ] Create `packages/cli/src/errors/formatter.ts`
  - [ ] Install chalk@5.3.0 for color formatting
  - [ ] Implement formatError function with red color for error type
  - [ ] Format error with sections: type, description, context, suggested fix
  - [ ] Add box drawing characters for visual separation
  - [ ] Handle stack trace formatting (conditional on verbose mode)
  - [ ] Export formatError for use in CLI error handlers

- [ ] Create logging utility with debug library (AC: 4, 5, 6, 7, 8)
  - [ ] Install debug@4.3.4 as dependency
  - [ ] Create `packages/cli/src/logging/logger.ts`
  - [ ] Define log namespaces: openapi-to-mcp:cli:*, openapi-to-mcp:parser:*, openapi-to-mcp:generator:*
  - [ ] Implement createLogger(namespace: string) factory function
  - [ ] Implement log level methods: error, warn, info, debug
  - [ ] Handle --verbose flag to enable DEBUG=openapi-to-mcp:*
  - [ ] Handle --quiet flag to suppress non-error output
  - [ ] Ensure sensitive data (credentials, API keys) never logged

- [ ] Define exit codes and error handling strategy (AC: 9)
  - [ ] Create `packages/cli/src/errors/exit-codes.ts` with enum
  - [ ] Define SUCCESS = 0, USER_ERROR = 1, INTERNAL_ERROR = 2
  - [ ] Map error classes to exit codes (ValidationError → 1, InternalError → 2)
  - [ ] Document exit code meanings in comments
  - [ ] Export exit code utilities

- [ ] Integrate error handling in CLI entry point (AC: 10)
  - [ ] Update `packages/cli/src/index.ts` or `cli.ts` with top-level try-catch
  - [ ] Catch all errors from command execution
  - [ ] Use formatError to display errors to user
  - [ ] Set appropriate process.exitCode based on error type
  - [ ] Handle unhandled promise rejections with process.on('unhandledRejection')
  - [ ] Handle uncaught exceptions with process.on('uncaughtException')
  - [ ] Log errors with correlation ID (UUID)

- [ ] Integrate logging in CLI commands (AC: 5, 6, 7)
  - [ ] Update generate command to use logger
  - [ ] Replace console.log with logger.info for user-facing messages
  - [ ] Add logger.debug for detailed execution steps
  - [ ] Use logger.warn for non-critical warnings
  - [ ] Use logger.error for error scenarios
  - [ ] Ensure --verbose and --quiet flags are respected

- [ ] Create comprehensive error tests (AC: 1-10)
  - [ ] Create `packages/cli/__tests__/errors/base-error.test.ts`
  - [ ] Test custom error class instantiation and properties
  - [ ] Test error serialization for logging
  - [ ] Create `packages/cli/__tests__/errors/formatter.test.ts`
  - [ ] Test error formatting with and without verbose mode
  - [ ] Test color formatting (use chalk utilities)
  - [ ] Test suggested fix display
  - [ ] Mock chalk in tests for deterministic output

- [ ] Create logging tests (AC: 4, 5, 6, 7, 8)
  - [ ] Create `packages/cli/__tests__/logging/logger.test.ts`
  - [ ] Test logger factory creates correct namespaces
  - [ ] Test log level filtering (info vs debug)
  - [ ] Test --verbose flag enables debug output
  - [ ] Test --quiet flag suppresses non-error output
  - [ ] Test sensitive data is NOT logged (mock logger, verify no leaks)
  - [ ] Test correlation ID is included in logs

- [ ] Create exit code and error handling integration tests (AC: 9, 10)
  - [ ] Create `packages/cli/__tests__/errors/integration.test.ts`
  - [ ] Test CLI exit codes for different error scenarios
  - [ ] Test unhandled rejection handling
  - [ ] Test uncaught exception handling
  - [ ] Test graceful error recovery
  - [ ] Verify no errors escape to console unformatted
  - [ ] Test error context preservation through pipeline

- [ ] Update existing CLI command error handling (AC: 2, 3, 10)
  - [ ] Review generate command error paths
  - [ ] Replace generic Error throws with custom error classes
  - [ ] Add context and suggested fixes to all errors
  - [ ] Ensure errors bubble up to top-level handler
  - [ ] Test error scenarios: missing file, invalid OpenAPI, permission denied

- [ ] Document error handling conventions (AC: 1-10)
  - [ ] Update docs/architecture/architecture.md#error-handling-strategy if needed
  - [ ] Create docs/errors.md with error catalog
  - [ ] Document all error classes with examples
  - [ ] Document exit codes and their meanings
  - [ ] Document logging namespaces and usage
  - [ ] Add troubleshooting guide for common errors
  - [ ] Document how to enable verbose logging

- [ ] Validate error handling across all scenarios (AC: 10)
  - [ ] Test with invalid OpenAPI file path
  - [ ] Test with malformed OpenAPI YAML/JSON
  - [ ] Test with missing required flags
  - [ ] Test with file system permission errors
  - [ ] Test with network errors (external $ref)
  - [ ] Verify all scenarios show formatted errors with suggested fixes
  - [ ] Verify appropriate exit codes for each scenario

## Dev Notes

### Error Handling Architecture
[Source: docs/architecture/architecture.md#error-handling-strategy]

**Error Model**: Typed errors with structured context

**Exception Hierarchy**:
```typescript
BaseError
├── CLIError (user-facing)
│   ├── ValidationError
│   ├── FileSystemError
│   └── UserInputError
├── InternalError
│   ├── ParserError
│   ├── GeneratorError
│   └── CompilationError
└── NetworkError
    ├── ExternalRefError
    └── RegistryError
```

**Required Context in Errors**:
- Error type (class name)
- Human-readable description
- File/location context (where error occurred)
- Suggested fix (actionable guidance)
- Correlation ID (UUID) for tracking

**Exit Codes**:
- `0`: Success
- `1`: User errors (invalid input, validation failures)
- `2`: Internal errors (bugs, unexpected failures)

### Logging Standards
[Source: docs/architecture/architecture.md#error-handling-strategy]

**Library**: `debug@4.3.4`

**Namespaces**:
- `openapi-to-mcp:cli:*` - CLI-level logging
- `openapi-to-mcp:parser:*` - Parser-level logging
- `openapi-to-mcp:generator:*` - Generator-level logging

**Required Context in Logs**:
- Correlation ID (UUID) for request tracing
- Log level (error, warn, info, debug)
- Namespace for filtering

**Security Requirements**:
- **NEVER log credentials** (API keys, tokens, passwords)
- **NEVER log OpenAPI contents** (may contain secrets)
- **NEVER log environment variables** (may contain secrets)
- Use `[REDACTED]` placeholder for sensitive data

**Log Levels**:
- `error`: Critical failures requiring user action
- `warn`: Non-critical issues or deprecations
- `info`: Important progress messages (default level)
- `debug`: Detailed execution flow (enabled with `--verbose`)

### Error Handling Patterns
[Source: docs/architecture/architecture.md#error-handling-strategy]

**Retry Policy**:
- Exponential backoff (3 attempts, 1-10s delay)
- Circuit breaker: 5 failures → 30s timeout
- Applies to: External $ref fetching, network operations

**Data Consistency**:
- Atomic file writes (temp directory + rename)
- Rollback on failure (delete partial output)
- Clean up resources in finally blocks

**Top-Level Error Handling**:
- Catch all errors in CLI entry point
- Format with chalk for readability
- Display error type, description, context, suggested fix
- Set appropriate exit code
- Handle unhandled promise rejections
- Handle uncaught exceptions

### CLI Error Display Format
[Source: docs/architecture/architecture.md#error-handling-strategy]

**Example Error Display**:
```
┌─────────────────────────────────────────────────┐
│ ❌ ValidationError                              │
├─────────────────────────────────────────────────┤
│ Invalid OpenAPI document                        │
│                                                 │
│ Context: /path/to/openapi.yaml:12:5            │
│ Missing required field: 'info.title'           │
│                                                 │
│ Suggested Fix:                                 │
│ Add a 'title' field to the 'info' section     │
│ Example: info.title: "My API"                  │
└─────────────────────────────────────────────────┘
```

**Stack Trace** (only with `--verbose`):
```
Stack trace:
  at parseOpenAPI (/packages/parser/src/parser.ts:45:11)
  at generateCommand (/packages/cli/src/commands/generate.ts:23:5)
  ...
```

### Coding Standards for Error Handling
[Source: docs/architecture/architecture.md#coding-standards]

**Critical Rules**:
1. **Never use `console.log`** - Use `debug` library instead
2. **All async must have error handling** - Wrap in try-catch or `.catch()`
3. **All errors must be typed** - Use custom error classes, never throw strings
4. **Never hardcode secrets** - Use `process.env`, never log secrets
5. **Use `unknown` not `any`** - Force explicit type checking for errors

**Error Class Design**:
```typescript
// BaseError - all custom errors extend this
export class BaseError extends Error {
  constructor(
    message: string,
    public readonly context?: Record<string, unknown>,
    public readonly suggestedFix?: string
  ) {
    super(message);
    this.name = this.constructor.name;
    Error.captureStackTrace(this, this.constructor);
  }

  toJSON() {
    return {
      name: this.name,
      message: this.message,
      context: this.context,
      suggestedFix: this.suggestedFix,
      stack: this.stack
    };
  }
}
```

### Integration with CLI Commands
[Source: Previous Story 1.3 context]

**CLI Package Structure**:
```
packages/cli/
├── src/
│   ├── index.ts              # Entry point with top-level error handling
│   ├── cli.ts                # Commander.js setup
│   ├── commands/
│   │   └── generate.ts       # Generate command (needs error integration)
│   ├── errors/               # THIS STORY
│   │   ├── base-error.ts
│   │   ├── cli-error.ts
│   │   ├── file-system-error.ts
│   │   ├── validation-error.ts
│   │   ├── formatter.ts
│   │   └── exit-codes.ts
│   ├── logging/              # THIS STORY
│   │   └── logger.ts
│   └── types.ts
└── __tests__/
    ├── cli.test.ts           # Existing tests from Story 1.3
    ├── errors/               # THIS STORY
    │   ├── base-error.test.ts
    │   ├── formatter.test.ts
    │   └── integration.test.ts
    └── logging/              # THIS STORY
        └── logger.test.ts
```

**Commander.js Integration**:
[Source: Story 1.3 implementation]

The CLI uses Commander.js for command parsing. Error handling must integrate with:
- Command action handlers (async functions)
- Flag validation (--verbose, --quiet)
- Global error handling in index.ts

**Example Integration**:
```typescript
// packages/cli/src/index.ts
import { program } from 'commander';
import { formatError } from './errors/formatter.js';
import { getExitCode } from './errors/exit-codes.js';

async function main() {
  try {
    await program.parseAsync(process.argv);
  } catch (error) {
    console.error(formatError(error));
    process.exitCode = getExitCode(error);
  }
}

// Handle unhandled rejections
process.on('unhandledRejection', (reason) => {
  console.error('Unhandled promise rejection:', reason);
  process.exitCode = 2;
});

main();
```

### Dependencies to Install
[Source: docs/architecture/architecture.md#tech-stack]

**New Dependencies**:
- `debug@4.3.4` - Logging library
- `chalk@5.3.0` - Terminal color formatting (may already be installed from Story 1.3)
- `uuid@9.0.1` - Correlation ID generation

**DevDependencies**:
- `@types/debug@4.1.12` - TypeScript types for debug
- `@types/uuid@9.0.7` - TypeScript types for uuid

All dependencies use **exact version pinning** (no `^` or `~`).

### File Locations
[Source: docs/architecture/architecture.md#source-tree]

**Files to Create**:
- `packages/cli/src/errors/base-error.ts`
- `packages/cli/src/errors/cli-error.ts`
- `packages/cli/src/errors/file-system-error.ts`
- `packages/cli/src/errors/validation-error.ts`
- `packages/cli/src/errors/formatter.ts`
- `packages/cli/src/errors/exit-codes.ts`
- `packages/cli/src/logging/logger.ts`
- `packages/cli/__tests__/errors/base-error.test.ts`
- `packages/cli/__tests__/errors/formatter.test.ts`
- `packages/cli/__tests__/errors/integration.test.ts`
- `packages/cli/__tests__/logging/logger.test.ts`
- `docs/errors.md` (error catalog and troubleshooting)

**Files to Modify**:
- `packages/cli/src/index.ts` (add top-level error handling)
- `packages/cli/src/commands/generate.ts` (integrate custom errors and logging)
- `packages/cli/package.json` (add dependencies: debug, chalk, uuid)
- `packages/cli/src/cli.ts` (integrate --verbose and --quiet flags if needed)

### Previous Story Context
[Source: Story 1.6 draft]

**Story 1.6** set up Vitest testing framework with:
- Root-level `vitest.config.ts` for workspace coordination
- Coverage reporting with 80%+ threshold
- CI/CD integration via GitHub Actions

**Testing Requirements for This Story**:
- All error classes must have unit tests
- Error formatting must have visual regression tests (snapshot tests)
- Logger must have integration tests with different log levels
- Coverage must meet 80%+ threshold set in Story 1.6

**Test Execution**:
```bash
# Run all tests
npm test

# Run with coverage
npm run test:coverage

# Run CLI package tests only
npm test --workspace=packages/cli
```

## Testing

### Testing Standards
[Source: docs/architecture/architecture.md#test-strategy]

**Test Framework**: Vitest 1.2.0 (configured in Story 1.6)
**Coverage Target**: ≥80% line coverage (enforced)

**Test Types**:
1. **Unit Tests**: Error classes, logging utilities, formatters
2. **Integration Tests**: CLI error handling, exit codes, unhandled rejections
3. **Snapshot Tests**: Error message formatting (visual regression)

**Test Execution**:
```bash
# Run all tests
npm test

# Run with coverage
npm run test:coverage

# Run CLI tests only
npm test --workspace=packages/cli

# Run specific test file
npm test packages/cli/__tests__/errors/formatter.test.ts
```

### Story-Specific Testing Requirements

**Error Class Tests** (`base-error.test.ts`):
- Test BaseError instantiation with context and suggested fix
- Test error serialization (toJSON method)
- Test custom error classes extend BaseError correctly
- Test error name property matches class name
- Test stack trace capture

**Error Formatter Tests** (`formatter.test.ts`):
- Test formatError with all error types
- Test error display with and without verbose mode
- Test suggested fix rendering
- Test context field rendering
- Test stack trace conditional display
- Snapshot tests for visual regression
- Mock chalk to test color formatting

**Logger Tests** (`logger.test.ts`):
- Test logger factory creates correct namespaces
- Test log level filtering (info, warn, error, debug)
- Test --verbose enables debug output
- Test --quiet suppresses non-error output
- Test correlation ID generation and inclusion
- Test sensitive data redaction (mock logger, verify no credentials logged)
- Test namespace inheritance and filtering

**Integration Tests** (`integration.test.ts`):
- Test CLI exit codes for different error scenarios
- Test unhandled promise rejection handling
- Test uncaught exception handling
- Test error context preservation through CLI pipeline
- Test error formatting is applied before display
- Test CLI gracefully exits with appropriate codes
- Mock process.exit and process.exitCode for testing

**Acceptance**:
- All error classes instantiate correctly
- All errors display with formatted output (red color, box drawing)
- All errors include context and suggested fix
- Logger respects --verbose and --quiet flags
- Stack traces only shown in verbose mode
- Exit codes match specification (0, 1, 2)
- No unhandled rejections escape to console
- Coverage ≥80% for all error and logging modules

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-03 | 1.0 | Initial story creation | Bob (Scrum Master) |
| 2025-01-04 | 1.1 | Validation complete - no corrections needed, approved for development | Sarah (Product Owner) |

## Dev Agent Record

*This section will be populated by the development agent during implementation.*

### Agent Model Used

*To be completed by Dev Agent*

### Debug Log References

*To be completed by Dev Agent*

### Completion Notes List

*To be completed by Dev Agent*

### File List

*To be completed by Dev Agent*

## QA Results

*This section will be populated by QA Agent after story completion.*
