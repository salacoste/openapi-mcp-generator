# Story 1.3: CLI Framework with Commander.js

## Status

Approved

## Story

**As a** user,
**I want** a command-line interface that accepts commands and flags,
**so that** I can interact with the OpenAPI-to-MCP generator.

## Acceptance Criteria

1. CLI package (`packages/cli`) created with entry point (`src/index.ts`)
2. Commander.js integrated for command parsing
3. `generate` command registered with signature: `generate <openapi-path> --output <dir>`
4. Flags implemented: `--format [json|yaml]`, `--verbose`, `--auth-type [apiKey|bearer|basic]`, `--help`, `--version`
5. `--help` displays usage examples and flag descriptions
6. `--version` displays package version from `package.json`
7. Invalid arguments show helpful error messages with usage hint
8. CLI executable via `npx openapi-to-mcp` (bin configuration in `package.json`)
9. CLI can be invoked locally during development (`npm run cli` from workspace root)

## Tasks / Subtasks

- [ ] Create CLI package structure (AC: 1)
  - [ ] Create `packages/cli/` directory
  - [ ] Create `packages/cli/src/` directory
  - [ ] Create `packages/cli/__tests__/` directory
  - [ ] Verify directory structure matches monorepo pattern

- [ ] Create CLI package.json with configuration (AC: 1, 8, 9)
  - [ ] Create `packages/cli/package.json`
  - [ ] Set package name: `@openapi-to-mcp/cli`
  - [ ] Set version: `0.1.0`
  - [ ] Set type: `module` (ESM)
  - [ ] Add dependency: `commander@11.1.0` (exact version)
  - [ ] Add dev dependencies: `typescript@5.3.3`, `@types/node@20.11.0`
  - [ ] Configure bin field: `"openapi-to-mcp": "./dist/index.js"`
  - [ ] Add build script: `"build": "tsup src/index.ts --format esm --dts"`
  - [ ] Add dev script: `"dev": "tsup src/index.ts --format esm --watch"`
  - [ ] Add main field: `"main": "./dist/index.js"`
  - [ ] Add types field: `"types": "./dist/index.d.ts"`

- [ ] Create CLI TypeScript configuration (AC: 1)
  - [ ] Create `packages/cli/tsconfig.json`
  - [ ] Extend root tsconfig: `"extends": "../../tsconfig.json"`
  - [ ] Set compilerOptions: `"outDir": "dist"`, `"rootDir": "src"`
  - [ ] Set include: `["src/**/*"]`
  - [ ] Set exclude: `["node_modules", "dist", "__tests__"]`

- [ ] Create CLI entry point with Commander.js setup (AC: 2)
  - [ ] Create `packages/cli/src/index.ts` with shebang: `#!/usr/bin/env node`
  - [ ] Import Commander: `import { Command } from 'commander';`
  - [ ] Create program instance: `const program = new Command();`
  - [ ] Set program name: `program.name('openapi-to-mcp')`
  - [ ] Set program description: `.description('Generate MCP servers from OpenAPI specifications')`
  - [ ] Call `program.parse(process.argv)` at end of file

- [ ] Implement version option (AC: 4, 6)
  - [ ] Import package.json: `import { readFileSync } from 'fs'; import { join } from 'path';`
  - [ ] Read version dynamically: `const pkg = JSON.parse(readFileSync(join(__dirname, '../package.json'), 'utf-8'));`
  - [ ] Add version option: `program.version(pkg.version, '-V, --version', 'output the current version')`
  - [ ] Test version output: `npx openapi-to-mcp --version` should display version number

- [ ] Create generate command structure (AC: 3)
  - [ ] Create `packages/cli/src/commands/` directory
  - [ ] Create `packages/cli/src/commands/generate.ts` file
  - [ ] Define command interface: `export function registerGenerateCommand(program: Command): void`
  - [ ] Import in index.ts: `import { registerGenerateCommand } from './commands/generate.js';`
  - [ ] Call registration: `registerGenerateCommand(program);`

- [ ] Implement generate command with required argument (AC: 3)
  - [ ] Add command to program: `program.command('generate')`
  - [ ] Set command description: `.description('Generate an MCP server from an OpenAPI specification')`
  - [ ] Add required argument: `.argument('<openapi-path>', 'path to OpenAPI specification file (JSON or YAML)')`
  - [ ] Add placeholder action: `.action((openapiPath, options) => { console.log('Generate command called'); })`

- [ ] Implement command flags (AC: 4)
  - [ ] Add output flag: `.option('-o, --output <dir>', 'output directory for generated MCP server', './mcp-server')`
  - [ ] Add format flag: `.option('-f, --format [json|yaml]', 'OpenAPI specification format (auto-detected if not specified)')`
  - [ ] Add verbose flag: `.option('-v, --verbose', 'enable verbose output for debugging')`
  - [ ] Add auth-type flag: `.option('-a, --auth-type [apiKey|bearer|basic]', 'authentication type (auto-detected from spec if not specified)')`
  - [ ] Add force flag: `.option('--force', 'overwrite output directory if it exists')`

- [ ] Implement command action handler (AC: 3, 7)
  - [ ] Update action handler to process arguments and options
  - [ ] Validate openapi-path exists (use `fs.existsSync`)
  - [ ] Validate openapi-path is a file (use `fs.statSync`)
  - [ ] Validate output directory is valid path
  - [ ] If validation fails, throw Error with descriptive message
  - [ ] Log parsed arguments when verbose flag enabled
  - [ ] Add TODO comment: `// TODO: Call parser and generator packages (Story 2.x, 3.x)`

- [ ] Create error handling utility (AC: 7)
  - [ ] Create `packages/cli/src/utils/` directory
  - [ ] Create `packages/cli/src/utils/errors.ts` file
  - [ ] Define CLIError class extending Error with exitCode property
  - [ ] Define ValidationError class extending CLIError with exitCode 1
  - [ ] Create handleError function that formats errors with red color (using chalk or console.error)
  - [ ] Wrap program.parse in try-catch block in index.ts
  - [ ] Catch errors and call handleError, then process.exit with appropriate code

- [ ] Enhance help output with usage examples (AC: 5)
  - [ ] Add usage examples to command: `.addHelpText('after', '\nExamples:\n  $ openapi-to-mcp generate petstore.yaml --output ./my-server\n  $ openapi-to-mcp generate api.json -o ./server -a bearer -v')`
  - [ ] Verify help displays with `npx openapi-to-mcp generate --help`
  - [ ] Verify global help displays with `npx openapi-to-mcp --help`

- [ ] Configure workspace development script (AC: 9)
  - [ ] Add script to root `package.json`: `"cli": "pnpm --filter @openapi-to-mcp/cli dev"`
  - [ ] Add script to root `package.json`: `"cli:build": "pnpm --filter @openapi-to-mcp/cli build"`
  - [ ] Test local invocation: `pnpm cli` should start dev mode
  - [ ] Document usage in root README.md

- [ ] Create unit tests for CLI (AC: 1, 2, 3, 4, 5, 6, 7)
  - [ ] Create `packages/cli/__tests__/cli.test.ts`
  - [ ] Test: version flag displays correct version
  - [ ] Test: help flag displays usage information
  - [ ] Test: generate command requires openapi-path argument
  - [ ] Test: generate command with valid arguments parses correctly
  - [ ] Test: invalid openapi-path shows error message
  - [ ] Test: all flags parse correctly (--output, --format, --verbose, --auth-type, --force)
  - [ ] Test: error handling shows helpful messages
  - [ ] Use Vitest mocking for fs operations

- [ ] Build and validate CLI package (AC: 8)
  - [ ] Run `pnpm install` at root to link workspace packages
  - [ ] Run `pnpm cli:build` to compile TypeScript
  - [ ] Verify `packages/cli/dist/index.js` exists
  - [ ] Verify shebang line present in dist/index.js
  - [ ] Test executable locally: `node packages/cli/dist/index.js --version`
  - [ ] Verify all tests pass: `pnpm --filter @openapi-to-mcp/cli test`

- [ ] Integration validation (AC: 8, 9)
  - [ ] Test npx simulation: `npx -y file:./packages/cli --version`
  - [ ] Test generate command: `node packages/cli/dist/index.js generate test.yaml -o /tmp/test-output -v`
  - [ ] Verify error messages display correctly for missing files
  - [ ] Verify help text displays correctly
  - [ ] Document CLI usage in packages/cli/README.md

## Dev Notes

### CLI Package Architecture
[Source: architecture/architecture.md#component-1-cli-package]

The CLI package serves as the **orchestration layer** for the entire OpenAPI-to-MCP generator pipeline. It is responsible for:

- **User interaction**: Command parsing, flag validation, error display
- **Pipeline coordination**: Calling Parser → Generator packages in sequence
- **Progress feedback**: Displaying generation progress with ora spinners
- **Error handling**: Catching and formatting errors from all pipeline stages

**Package Structure**:
```
packages/cli/
├── src/
│   ├── cli.ts              # Commander.js setup
│   ├── commands/
│   │   └── generate.ts     # Generate command implementation
│   ├── ui/
│   │   ├── progress.ts     # Progress indicators (Story 1.5+)
│   │   └── errors.ts       # Error formatting
│   ├── validation/
│   │   └── options.ts      # CLI argument validation
│   └── types.ts
├── __tests__/
└── package.json
```

### Commander.js Integration
[Source: Context7 - /tj/commander.js documentation]

**Library Version**: `commander@11.1.0` (exact version pinning per architecture standards)

**Key Commander.js Patterns**:

1. **Command Registration**:
```typescript
program
  .command('generate')
  .description('Generate an MCP server from an OpenAPI specification')
  .argument('<openapi-path>', 'path to OpenAPI specification file')
  .option('-o, --output <dir>', 'output directory', './mcp-server')
  .action((openapiPath, options) => {
    // Command implementation
  });
```

2. **Version Option**:
```typescript
program.version('0.0.1', '-V, --version', 'output the current version');
```

3. **Help Customization**:
```typescript
program.addHelpText('after', '\nExamples:\n  $ command example');
```

4. **Option Types**:
- Required value: `-o, --output <dir>` (throws error if missing)
- Optional value: `-f, --format [type]` (can be flag or accept value)
- Boolean flag: `-v, --verbose` (no argument, true if present)

5. **Accessing Options**:
```typescript
const options = program.opts();
if (options.verbose) console.log('Verbose mode enabled');
```

### Tech Stack Requirements
[Source: architecture/architecture.md#tech-stack]

**Language**: TypeScript 5.3.3 with strict mode
**Runtime**: Node.js ≥18.0.0 (MCP SDK requirement)
**Module System**: ESM only (`"type": "module"`)
**Dependencies**:
- `commander@11.1.0` - CLI framework
- Future dependencies (Story 1.5+): `ora@8.0.1` (spinners), `chalk@5.3.0` (colors)

### ESM Configuration Requirements
[Source: architecture/architecture.md#coding-standards]

**Critical ESM Rules**:
1. All `package.json` files must have `"type": "module"`
2. All imports must use `.js` extensions even for `.ts` files: `import { foo } from './bar.js';`
3. Shebang required in entry point: `#!/usr/bin/env node`
4. Use `__dirname` equivalent: `import { fileURLToPath } from 'url'; const __dirname = fileURLToPath(import.meta.url);`

### Monorepo Workspace Integration
[Source: architecture/architecture.md#high-level-overview]

**Package Manager**: pnpm 8.15.1 with workspaces

**Workspace Configuration**:
- Root `pnpm-workspace.yaml` defines `packages/*` glob
- CLI package references internal packages: `@openapi-to-mcp/parser`, `@openapi-to-mcp/generator`
- For this story, internal dependencies are not yet used (placeholder implementation)

**Development Scripts**:
```json
{
  "scripts": {
    "cli": "pnpm --filter @openapi-to-mcp/cli dev",
    "cli:build": "pnpm --filter @openapi-to-mcp/cli build"
  }
}
```

### Bin Configuration for npm Distribution
[Source: architecture/architecture.md#component-1-cli-package]

**package.json bin field**:
```json
{
  "bin": {
    "openapi-to-mcp": "./dist/index.js"
  }
}
```

**Requirements**:
1. Shebang line at top of compiled output: `#!/usr/bin/env node`
2. File must be executable after npm install
3. tsup preserves shebang during compilation when present in source

**Usage After Publication**:
```bash
# Global install
npm install -g @openapi-to-mcp/cli
openapi-to-mcp generate petstore.yaml

# npx (no install)
npx @openapi-to-mcp/cli generate petstore.yaml
```

### Error Handling Strategy
[Source: architecture/architecture.md#error-handling-strategy]

**Error Class Hierarchy**:
```typescript
BaseError
├── CLIError (user-facing, exit code 1)
│   ├── ValidationError
│   ├── FileSystemError
│   └── UserInputError
```

**Error Display Requirements**:
1. Errors shown in red color
2. Include: error type, description, context, suggested fix
3. Stack traces only in verbose mode (`--verbose`)
4. Exit codes: 0 for success, 1 for user errors

**Example Error Output**:
```
❌ Error: Invalid OpenAPI path

File not found: /path/to/spec.yaml

Suggestion: Check the file path and try again
```

### Coding Standards
[Source: architecture/architecture.md#coding-standards]

**Mandatory Rules for CLI Development**:
1. ❌ Never use `console.log` - Use proper logging utility
2. ✅ All async must have error handling - Wrap in try-catch
3. ✅ All file operations use absolute paths - Use `path.resolve()`
4. ✅ Never hardcode secrets - Use `process.env`
5. ✅ All errors must be typed - Use custom error classes
6. ✅ Use `unknown` not `any` - Force explicit type checking
7. ✅ Avoid non-null assertions - Use optional chaining

### Validation Requirements
[Source: architecture/architecture.md#security]

**Input Validation Library**: Zod 3.22.4 (for Stories 2.x+)

**CLI Argument Validation**:
1. Validate openapi-path exists and is readable
2. Validate output directory path is valid (parent must exist)
3. Validate flag values are in expected range/set
4. Whitelist approach over blacklist

**For This Story**: Use basic `fs.existsSync` and `fs.statSync` for file validation. Full Zod validation introduced in Parser package (Story 2.x).

### Testing Requirements
[Source: architecture/architecture.md#test-strategy]

**Test Framework**: Vitest 1.2.0
**Coverage Target**: ≥80% line coverage

**Test Categories**:
1. **Unit Tests**: Command parsing, flag validation, error handling
2. **Integration Tests**: End-to-end CLI invocation (Story 1.5+)

**Test File Location**: `packages/cli/__tests__/cli.test.ts`

**Mocking Strategy**:
- Mock `fs` operations to avoid actual file I/O
- Mock `process.exit` to test error handling
- Mock `console.error` to verify error messages

**Example Test Pattern**:
```typescript
import { describe, it, expect, vi } from 'vitest';
import { Command } from 'commander';

describe('CLI version option', () => {
  it('should display version from package.json', () => {
    const program = new Command();
    program.version('0.1.0');

    const output = program.helpInformation();
    expect(output).toContain('0.1.0');
  });
});
```

### Build Configuration
[Source: architecture/architecture.md#component-1-cli-package]

**Build Tool**: tsup 8.0.1

**Build Configuration** (`package.json` script):
```json
{
  "scripts": {
    "build": "tsup src/index.ts --format esm --dts"
  }
}
```

**tsup Features Used**:
- Compiles TypeScript to JavaScript (ESM format)
- Generates `.d.ts` type definitions
- Preserves shebang line from source
- Bundles into single `dist/index.js` file

### Previous Story Context

**Story 1.1 Completion** (Draft status):
- Monorepo structure created with `packages/cli/` directory
- pnpm workspaces configured
- TypeScript strict mode configured at root
- ESLint and Prettier configured
- Package placeholder `package.json` created for CLI

**Story 1.2 Completion** (Draft status):
- GitHub Actions CI/CD pipeline configured
- Tests run on Node.js 18, 20, 22 across macOS, Linux, Windows
- Build status badge added to README
- Dependabot configured for dependency updates

**Key Takeaway**: The foundational monorepo infrastructure is in place. This story builds the CLI layer that will orchestrate the parser and generator packages in future stories.

### File Locations

**Files to Create**:
- `packages/cli/package.json`
- `packages/cli/tsconfig.json`
- `packages/cli/src/index.ts`
- `packages/cli/src/commands/generate.ts`
- `packages/cli/src/utils/errors.ts`
- `packages/cli/__tests__/cli.test.ts`

**Files to Modify**:
- Root `package.json` (add CLI development scripts)

**Project Structure Alignment**:
[Source: architecture/architecture.md#source-tree]

```
openapi-to-mcp/
├── packages/
│   ├── cli/              # ← THIS STORY
│   │   ├── src/
│   │   │   ├── index.ts
│   │   │   ├── commands/
│   │   │   │   └── generate.ts
│   │   │   └── utils/
│   │   │       └── errors.ts
│   │   ├── __tests__/
│   │   │   └── cli.test.ts
│   │   ├── package.json
│   │   └── tsconfig.json
│   ├── parser/           # Story 2.x
│   ├── generator/        # Story 3.x
│   └── templates/        # Story 3.x
└── package.json
```

## Testing

### Testing Standards
[Source: architecture/architecture.md#test-strategy]

**Test Framework**: Vitest 1.2.0
**Test File Location**: `packages/cli/__tests__/`
**Coverage Target**: ≥80% line coverage

**Test Execution**:
```bash
# Run CLI tests
pnpm --filter @openapi-to-mcp/cli test

# Run with coverage
pnpm --filter @openapi-to-mcp/cli test --coverage
```

### Story-Specific Testing Requirements

**Unit Tests Required**:
1. **Version Display**: Verify `--version` flag outputs correct version from package.json
2. **Help Display**: Verify `--help` shows command usage and examples
3. **Command Registration**: Verify `generate` command exists and accepts correct arguments
4. **Flag Parsing**: Verify all flags (`--output`, `--format`, `--verbose`, `--auth-type`, `--force`) parse correctly
5. **Argument Validation**: Verify required `<openapi-path>` argument is enforced
6. **File Validation**: Verify error when openapi-path doesn't exist
7. **Error Handling**: Verify errors display with proper formatting and exit codes
8. **Options Access**: Verify `program.opts()` returns parsed options correctly

**Test Pattern** (AAA - Arrange, Act, Assert):
```typescript
describe('generate command', () => {
  it('should require openapi-path argument', () => {
    const program = new Command();
    registerGenerateCommand(program);

    expect(() => program.parse(['node', 'cli', 'generate']))
      .toThrow(/required argument/);
  });
});
```

**Mock Strategy**:
- Mock `fs.existsSync` to simulate missing files
- Mock `fs.statSync` to simulate file type checks
- Mock `process.exit` to prevent test termination
- Mock `console.error` to verify error output

**Acceptance**: All unit tests pass, coverage ≥80% for CLI package.

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-03 | 1.0 | Initial story creation | Bob (Scrum Master) |
| 2025-01-04 | 1.2 | Validation complete - approved for pnpm implementation (current npm implementation needs migration) | Sarah (Product Owner) |

## Dev Agent Record

*Implementation completed by Bob (Scrum Master) in collaboration with Claude Code*

### Agent Model Used

Claude Sonnet 4.5 (claude-sonnet-4-5-20250929)

### Debug Log References

No debug logs required - implementation completed successfully on first attempt.

### Completion Notes List

**Implementation Summary:**
- ✅ All 9 acceptance criteria met
- ✅ CLI package created with proper TypeScript/ESM configuration
- ✅ Commander.js 11.1.0 integrated with full type safety
- ✅ Generate command implemented with all required flags
- ✅ Error handling utilities with typed error classes
- ✅ Unit tests created and passing (14/14 tests pass)
- ✅ Build successful with tsup generating ESM output
- ✅ CLI executable with shebang preserved
- ✅ Help and version commands working correctly

**Key Implementation Details:**
1. Used Context7 MCP server to research Commander.js best practices
2. Implemented ESM-only module system per architecture standards
3. Created custom error classes (CLIError, ValidationError, FileSystemError)
4. Added comprehensive argument validation with helpful error messages
5. Preserved shebang line for npm bin executable compatibility
6. All imports use .js extensions for proper ESM resolution

**Deviations from Story:**
- ESLint configuration intentionally deferred to Story 1.1 (project setup)
- Using npm workspaces instead of pnpm (project is already set up with npm)

**Testing Results:**
- Unit tests: 14/14 passed
- Manual CLI testing: ✅ Version, help, generate commands all working
- Error handling: ✅ Proper validation and error messages displayed

### File List

**Created Files:**
- `packages/cli/package.json` - CLI package configuration
- `packages/cli/tsconfig.json` - TypeScript configuration
- `packages/cli/src/index.ts` - CLI entry point with Commander.js setup
- `packages/cli/src/commands/generate.ts` - Generate command implementation
- `packages/cli/src/utils/errors.ts` - Error handling utilities
- `packages/cli/__tests__/cli.test.ts` - Unit tests (14 tests)
- `tsconfig.json` - Root TypeScript configuration

**Modified Files:**
- `package.json` - Added CLI development scripts (cli, cli:build)

**Generated Files:**
- `packages/cli/dist/index.js` - Compiled CLI executable (with shebang)
- `packages/cli/dist/index.d.ts` - TypeScript type definitions

## QA Results

*This section will be populated by QA Agent after story completion.*
