# Story 1.4: Basic File System Operations and Output Structure

## Status

Approved

## Story

**As a** developer,
**I want** utilities for creating directories and writing files,
**so that** the generator can output MCP server code to the file system.

## Acceptance Criteria

1. File system utility module created (`packages/generator/src/fs-utils.ts`)
2. Function `createDirectory(path)` creates directory with parent directories if needed
3. Function `writeFile(path, content)` writes string content to file with UTF-8 encoding
4. Function `copyTemplate(source, dest)` copies template files to output directory
5. Error handling for file system errors (permissions, disk space) with clear messages
6. Output directory structure validated: `<output-dir>/src/`, `<output-dir>/package.json`, `<output-dir>/README.md`
7. If output directory exists, prompt user for confirmation or use `--force` flag to overwrite
8. All file operations logged in verbose mode (`--verbose`)

## Tasks / Subtasks

- [ ] Create Generator package structure (AC: 1)
  - [ ] Create `packages/generator/` directory
  - [ ] Create `packages/generator/src/` directory
  - [ ] Create `packages/generator/__tests__/` directory
  - [ ] Verify directory structure matches monorepo pattern

- [ ] Create Generator package.json with configuration (AC: 1)
  - [ ] Create `packages/generator/package.json`
  - [ ] Set package name: `@openapi-to-mcp/generator`
  - [ ] Set version: `0.1.0`
  - [ ] Set type: `module` (ESM)
  - [ ] Add dependency: `fs-extra@11.2.0` (exact version per architecture)
  - [ ] Add dev dependencies: `typescript@5.3.3`, `@types/node@20.11.0`, `@types/fs-extra@11.0.4`
  - [ ] Configure build script: `"build": "tsup src/index.ts --format esm --dts"`
  - [ ] Configure test script: `"test": "vitest run"`
  - [ ] Add main field: `"main": "./dist/index.js"`
  - [ ] Add types field: `"types": "./dist/index.d.ts"`

- [ ] Create Generator TypeScript configuration (AC: 1)
  - [ ] Create `packages/generator/tsconfig.json`
  - [ ] Extend root tsconfig: `"extends": "../../tsconfig.json"`
  - [ ] Set compilerOptions: `"outDir": "dist"`, `"rootDir": "src"`
  - [ ] Set include: `["src/**/*"]`
  - [ ] Set exclude: `["node_modules", "dist", "__tests__"]`

- [ ] Create fs-utils.ts with createDirectory function (AC: 2)
  - [ ] Create `packages/generator/src/fs-utils.ts`
  - [ ] Import fs-extra: `import fs from 'fs-extra';`
  - [ ] Define `createDirectory(path: string): Promise<void>` function
  - [ ] Use `fs.ensureDir(path)` to create directory with parents
  - [ ] Add try-catch with FileSystemError for permissions/disk space errors
  - [ ] Use absolute paths: `path.resolve(dirPath)` before operations
  - [ ] Add verbose logging when `process.env.VERBOSE === 'true'`

- [ ] Implement writeFile function (AC: 3)
  - [ ] Define `writeFile(filePath: string, content: string): Promise<void>` function
  - [ ] Use `fs.outputFile(filePath, content, 'utf-8')` for atomic writes with directory creation
  - [ ] Add try-catch with FileSystemError for write errors
  - [ ] Use absolute paths: `path.resolve(filePath)` before operations
  - [ ] Add verbose logging: log file path and content length

- [ ] Implement copyTemplate function (AC: 4)
  - [ ] Define `copyTemplate(source: string, dest: string): Promise<void>` function
  - [ ] Validate source directory exists with `fs.pathExists(source)`
  - [ ] Use `fs.copy(source, dest, { overwrite: false })` to copy template
  - [ ] Add try-catch with FileSystemError for copy errors
  - [ ] Use absolute paths for both source and destination
  - [ ] Add verbose logging: log source and destination paths

- [ ] Implement error handling for file system operations (AC: 5)
  - [ ] Import FileSystemError from CLI package: `import { FileSystemError } from '@openapi-to-mcp/cli';`
  - [ ] Create error mapping function for common fs errors
  - [ ] Map EACCES → "Permission denied" with suggested fix
  - [ ] Map ENOSPC → "No disk space available" with suggested fix
  - [ ] Map ENOENT → "Path not found" with suggested fix
  - [ ] Add context to errors: operation type, file path, original error message

- [ ] Create validateOutputStructure function (AC: 6)
  - [ ] Define `validateOutputStructure(outputDir: string): Promise<boolean>` function
  - [ ] Check for required structure: `src/`, `package.json`, `README.md`
  - [ ] Use `fs.pathExists()` for each required path
  - [ ] Return true if structure is valid, false otherwise
  - [ ] Add verbose logging: log validation results for each path

- [ ] Implement directory overwrite confirmation (AC: 7)
  - [ ] Create `checkOutputDirectory(outputDir: string, force: boolean): Promise<boolean>` function
  - [ ] Check if directory exists with `fs.pathExists(outputDir)`
  - [ ] If exists and `force === true`, call `fs.emptyDir(outputDir)` to clear contents
  - [ ] If exists and `force === false`, throw ValidationError with message
  - [ ] Add verbose logging: log overwrite decisions

- [ ] Create verbose logging utility (AC: 8)
  - [ ] Create `packages/generator/src/utils/logger.ts`
  - [ ] Define `log(message: string, ...args: unknown[]): void` function
  - [ ] Check `process.env.VERBOSE === 'true'` before logging
  - [ ] Use console.log for verbose output (acceptable for CLI verbose mode)
  - [ ] Format messages with prefix: `[generator]`

- [ ] Create index.ts export file (AC: 1)
  - [ ] Create `packages/generator/src/index.ts`
  - [ ] Export all functions from fs-utils: `export * from './fs-utils.js';`
  - [ ] Export logger utility: `export * from './utils/logger.js';`

- [ ] Create unit tests for file system utilities (AC: 2, 3, 4, 5, 6, 7, 8)
  - [ ] Create `packages/generator/__tests__/fs-utils.test.ts`
  - [ ] Test: createDirectory creates directory with parents
  - [ ] Test: createDirectory handles permission errors gracefully
  - [ ] Test: writeFile writes content with UTF-8 encoding
  - [ ] Test: writeFile creates parent directories automatically
  - [ ] Test: copyTemplate copies directory contents recursively
  - [ ] Test: copyTemplate handles missing source with error
  - [ ] Test: validateOutputStructure returns true for valid structure
  - [ ] Test: validateOutputStructure returns false for missing files
  - [ ] Test: checkOutputDirectory clears directory when force=true
  - [ ] Test: checkOutputDirectory throws error when force=false and dir exists
  - [ ] Test: verbose logging only outputs when VERBOSE=true
  - [ ] Use mock filesystem or temp directories for testing

- [ ] Build and validate Generator package (AC: 1-8)
  - [ ] Run `npm install` at root to install fs-extra
  - [ ] Run build: `npm run build --workspace=packages/generator`
  - [ ] Verify `packages/generator/dist/index.js` exists
  - [ ] Verify `packages/generator/dist/index.d.ts` exists
  - [ ] Run tests: `npm test --workspace=packages/generator`
  - [ ] Verify all tests pass with ≥80% coverage

- [ ] Integration testing with CLI package (AC: 7, 8)
  - [ ] Update CLI generate command to use generator fs-utils
  - [ ] Add generator package as dependency to CLI package.json
  - [ ] Test: generate command creates output structure
  - [ ] Test: --force flag clears existing directory
  - [ ] Test: --verbose flag shows file operations
  - [ ] Test: error messages display for file system failures

## Dev Notes

### Generator Package Architecture
[Source: docs/architecture/architecture.md#component-3-generator-package]

The Generator package is responsible for **code generation orchestration**, template rendering, and file system operations. For Story 1.4, we focus on the file system utilities layer that will be used by all generation strategies.

**Package Structure for this Story**:
```
packages/generator/
├── src/
│   ├── index.ts              # Main export file
│   ├── fs-utils.ts           # File system utilities (THIS STORY)
│   └── utils/
│       └── logger.ts         # Verbose logging utility
├── __tests__/
│   └── fs-utils.test.ts      # File system tests
├── package.json
└── tsconfig.json
```

**Future Structure** (Stories 3.x):
```
packages/generator/
├── src/
│   ├── index.ts
│   ├── generator.ts          # Story 3.x
│   ├── strategies/           # Story 3.x
│   ├── renderers/            # Story 3.x
│   ├── type-mapper/          # Story 3.x
│   ├── file-writer/          # This story's fs-utils
│   └── validation/           # Story 7.x
```

### fs-extra Library Integration
[Source: Context7 - /jprichardson/node-fs-extra]

**Library Version**: `fs-extra@11.2.0` (exact version per architecture standards)

**Why fs-extra over native fs:**
1. Promise-based API (no callback hell)
2. Auto-creates parent directories (`ensureDir`, `outputFile`)
3. Recursive copy operations (`copy`)
4. Atomic file writes (write to temp + rename)
5. Graceful-fs internally (prevents EMFILE errors)

**Key Functions for this Story**:

1. **`ensureDir(path)`** - Creates directory with parent directories
```typescript
import fs from 'fs-extra';
await fs.ensureDir('/path/to/dir'); // Creates all parent dirs if needed
```

2. **`outputFile(path, content, encoding)`** - Writes file with directory creation
```typescript
await fs.outputFile('/path/to/file.txt', 'content', 'utf-8');
// Creates parent directories automatically
```

3. **`copy(source, dest, options)`** - Recursive directory copy
```typescript
await fs.copy('/source/dir', '/dest/dir', {
  overwrite: false,
  errorOnExist: true
});
```

4. **`pathExists(path)`** - Check if path exists (async)
```typescript
const exists = await fs.pathExists('/path/to/check');
```

5. **`emptyDir(path)`** - Clear directory contents (keep dir itself)
```typescript
await fs.emptyDir('/path/to/dir'); // Deletes contents, not the directory
```

### Error Handling Strategy
[Source: docs/architecture/architecture.md#error-handling-strategy]

**File System Error Classes**:
```typescript
FileSystemError extends CLIError
  - exitCode: 1
  - context: { operation, path, originalError }
```

**Common fs-extra Error Codes**:
- `EACCES`: Permission denied
- `ENOSPC`: No space left on device
- `ENOENT`: No such file or directory
- `EEXIST`: File already exists
- `EISDIR`: Path is a directory (expected file)
- `ENOTDIR`: Path is a file (expected directory)

**Error Mapping Pattern**:
```typescript
try {
  await fs.ensureDir(path);
} catch (error) {
  const fsError = error as NodeJS.ErrnoException;
  if (fsError.code === 'EACCES') {
    throw new FileSystemError(
      `Permission denied creating directory: ${path}\nSuggestion: Check directory permissions or run with appropriate privileges`
    );
  }
  // ... other mappings
}
```

### Coding Standards for File Operations
[Source: docs/architecture/architecture.md#coding-standards]

**Critical Rules for this Story**:

1. ✅ **All file operations use absolute paths**
   - Use `path.resolve()` before any fs operation
   - Prevents relative path confusion and security issues

2. ✅ **All async operations have error handling**
   - Wrap all fs-extra calls in try-catch
   - Map errors to typed FileSystemError

3. ✅ **Never use `console.log`**
   - Exception: Verbose mode logging is acceptable for CLI verbose output
   - Use logger utility that checks VERBOSE flag

4. ✅ **Atomic file writes**
   - fs-extra `outputFile` handles this internally (write to temp + rename)
   - Ensures partial writes don't corrupt files

5. ✅ **Use `unknown` not `any`**
   - Catch blocks: `catch (error)` → cast to `NodeJS.ErrnoException`

### ESM Configuration Requirements
[Source: docs/architecture/architecture.md#coding-standards]

**Critical ESM Rules** (same as Story 1.3):
1. All `package.json` files must have `"type": "module"`
2. All imports must use `.js` extensions: `import { x } from './y.js';`
3. No `__dirname` - use `import.meta.url` and `fileURLToPath()` if needed

### Testing Requirements
[Source: docs/architecture/architecture.md#test-strategy]

**Test Framework**: Vitest 1.2.0
**Coverage Target**: ≥80% line coverage

**Testing Strategy for File Operations**:
1. **Option A**: Use `memfs` or `mock-fs` to mock file system
2. **Option B**: Use OS temp directories for real file operations
3. **Recommended**: Option B for this story (real fs more reliable for fs-extra)

**Test File Location**: `packages/generator/__tests__/fs-utils.test.ts`

**Test Categories**:
1. **Happy Path**: Directory creation, file writing, template copying
2. **Error Handling**: Permission errors, missing paths, disk space simulation
3. **Edge Cases**: Existing directories, empty files, deeply nested paths
4. **Verbose Logging**: Verify logs only appear when VERBOSE=true

**Example Test Pattern**:
```typescript
import { describe, it, expect, beforeEach, afterEach } from 'vitest';
import { tmpdir } from 'os';
import { join } from 'path';
import { mkdtemp, rm } from 'fs/promises';
import { createDirectory } from '../src/fs-utils.js';

describe('createDirectory', () => {
  let testDir: string;

  beforeEach(async () => {
    testDir = await mkdtemp(join(tmpdir(), 'test-'));
  });

  afterEach(async () => {
    await rm(testDir, { recursive: true, force: true });
  });

  it('should create directory with parent directories', async () => {
    const nestedPath = join(testDir, 'a', 'b', 'c');
    await createDirectory(nestedPath);
    const exists = await fs.pathExists(nestedPath);
    expect(exists).toBe(true);
  });
});
```

### Integration with CLI Package
[Source: Story 1.3 completion context]

**CLI Package Integration Points**:
1. CLI already has `--force` flag defined in generate command
2. CLI already has `--verbose` flag and sets `process.env.VERBOSE`
3. CLI already has error handling utilities (FileSystemError)

**Integration Steps** (final task in this story):
1. Add generator package dependency to CLI package.json
2. Import fs-utils functions in generate command
3. Call `checkOutputDirectory()` before generation
4. Use `createDirectory()` for output structure
5. Pass verbose flag through environment variable

### Previous Story Context

**Story 1.3 Completion** (Done):
- CLI package structure created
- Commander.js 11.1.0 integrated
- Generate command with all flags (`--output`, `--force`, `--verbose`)
- Error handling utilities (CLIError, ValidationError, FileSystemError)
- TypeScript ESM configuration working
- Tests passing (14/14)

**Key Takeaway**: The CLI orchestration layer is ready. This story builds the file system layer that CLI will call to perform actual file operations.

### File Locations

**Files to Create**:
- `packages/generator/package.json`
- `packages/generator/tsconfig.json`
- `packages/generator/src/index.ts`
- `packages/generator/src/fs-utils.ts`
- `packages/generator/src/utils/logger.ts`
- `packages/generator/__tests__/fs-utils.test.ts`

**Files to Modify**:
- `packages/cli/package.json` (add generator dependency for integration testing)
- `packages/cli/src/commands/generate.ts` (integrate fs-utils after generator tests pass)

**Project Structure Alignment**:
[Source: docs/architecture/architecture.md#source-tree]

```
openapi-to-mcp/
├── packages/
│   ├── cli/              # Story 1.3 (Done)
│   ├── generator/        # THIS STORY
│   │   ├── src/
│   │   │   ├── index.ts
│   │   │   ├── fs-utils.ts
│   │   │   └── utils/
│   │   │       └── logger.ts
│   │   ├── __tests__/
│   │   │   └── fs-utils.test.ts
│   │   ├── package.json
│   │   └── tsconfig.json
│   ├── parser/           # Story 2.x
│   └── templates/        # Story 3.x
└── package.json
```

## Testing

### Testing Standards
[Source: docs/architecture/architecture.md#test-strategy]

**Test Framework**: Vitest 1.2.0
**Test File Location**: `packages/generator/__tests__/`
**Coverage Target**: ≥80% line coverage

**Test Execution**:
```bash
# Run Generator tests
npm test --workspace=packages/generator

# Run with coverage
npm test --workspace=packages/generator -- --coverage
```

### Story-Specific Testing Requirements

**Unit Tests Required**:
1. **createDirectory**:
   - Creates directory with parent directories
   - Handles existing directories gracefully
   - Throws FileSystemError for permission issues
   - Uses absolute paths

2. **writeFile**:
   - Writes string content with UTF-8 encoding
   - Creates parent directories automatically
   - Handles write errors with clear messages
   - Atomic writes (no partial files on error)

3. **copyTemplate**:
   - Copies directory contents recursively
   - Handles missing source directory
   - Respects overwrite flag
   - Preserves file structure

4. **validateOutputStructure**:
   - Returns true for valid structure (src/, package.json, README.md)
   - Returns false for missing required files
   - Checks all required paths

5. **checkOutputDirectory**:
   - Clears directory when force=true
   - Throws error when force=false and directory exists
   - Creates directory if it doesn't exist

6. **Verbose Logging**:
   - Logs operations when VERBOSE=true
   - Silent when VERBOSE=false or undefined
   - Includes relevant context (paths, operations)

**Test Patterns**:
- Use OS temp directories for real file operations
- Clean up test directories in afterEach
- Mock process.env.VERBOSE for logging tests
- Test both success and error paths

**Integration Tests** (with CLI):
- CLI generate command creates output structure
- --force flag clears existing directory
- --verbose flag shows file operations
- Error messages display correctly

**Acceptance**: All unit tests pass, coverage ≥80%, integration with CLI working.

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-03 | 1.0 | Initial story creation | Bob (Scrum Master) |
| 2025-01-04 | 1.1 | Validation complete - no corrections needed, approved for development | Sarah (Product Owner) |

## Dev Agent Record

*This section will be populated by the development agent during implementation.*

### Agent Model Used

*To be completed by Dev Agent*

### Debug Log References

*To be completed by Dev Agent*

### Completion Notes List

*To be completed by Dev Agent*

### File List

*To be completed by Dev Agent*

## QA Results

*This section will be populated by QA Agent after story completion.*
