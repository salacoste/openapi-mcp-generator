# Story 4.6: Security Scheme Detection and User Guidance - Brownfield Addition

**Epic:** Epic 4: Authentication & Security Handlers

---

## User Story

**As a** user,
**I want** clear guidance on which authentication credentials I need to provide,
**So that** I can configure the generated MCP server correctly.

---

## Story Context

**Existing System Integration:**
- Integrates with: Security extractor (2.6), scaffolding (3.8), all auth handlers (4.2-4.5)
- Technology: OpenAPI security analysis, documentation generation
- Follows pattern: User guidance and documentation
- Touch points: .env.example generation, README, CLI output

**Epic Context:**
Analyzes OpenAPI security requirements and generates clear user guidance for credential configuration. Helps users understand what auth is needed and how to configure it.

---

## Acceptance Criteria

### Functional Requirements

1. **Security Analyzer:** Create `security-analyzer.ts` to analyze OpenAPI security
2. **Guidance Report:** Generate security requirements summary
3. **Required vs Optional:** Identify which auth schemes are required
4. **Global vs Operation:** Detect global and operation-level security
5. **Unsupported Schemes:** Warn about OAuth2/OpenID Connect with workarounds
6. **.env.example:** Include all detected auth credentials with comments
7. **README Section:** "Authentication Setup" with step-by-step instructions
8. **CLI Output:** Display security requirements after parsing OpenAPI
9. **Example Values:** Provide fake example credentials in .env.example
10. **Documentation Links:** Link to API docs for obtaining credentials

### Integration Requirements

11. **Security Extraction:** Use Story 2.6 security scheme data
12. **.env.example Generation:** Enhance Story 3.8 scaffolding
13. **CLI Integration:** Display guidance during generation

### Quality Requirements

14. **Testing:** Various security configurations, unsupported schemes (≥80%)
15. **Documentation:** Clear, actionable guidance for all auth types
16. **Usability:** Users can configure auth without external help

---

## Technical Notes

```typescript
// security-analyzer.ts
export interface SecurityGuidance {
  required: string[];
  optional: string[];
  unsupported: { scheme: string; workaround: string }[];
  envVars: { name: string; description: string; example: string }[];
  docLinks: { scheme: string; url: string }[];
}

export function analyzeSecurityRequirements(openapi: OpenAPIDocument): SecurityGuidance {
  const guidance: SecurityGuidance = {
    required: [],
    optional: [],
    unsupported: [],
    envVars: [],
    docLinks: []
  };

  // Analyze security schemes and build guidance
  for (const [name, scheme] of Object.entries(openapi.components?.securitySchemes || {})) {
    if (scheme.type === 'apiKey') {
      guidance.required.push(name);
      guidance.envVars.push({
        name: 'API_KEY',
        description: `API Key for ${name} (${scheme.in}: ${scheme.name})`,
        example: 'your-api-key-here'
      });
    }
    // ... other schemes
  }

  return guidance;
}
```

**.env.example Enhancement:**
```bash
# =============================================================================
# AUTHENTICATION CREDENTIALS
# =============================================================================
# This API requires the following authentication:
#
# ✓ API Key (required) - Client-Id and Api-Key headers
# ✓ Bearer Token (optional) - For advanced features
#
# Follow the steps in README.md to obtain your credentials.
# =============================================================================

# API Key Authentication (REQUIRED)
# Location: Headers (Client-Id and Api-Key)
# Format: Client-Id:Api-Key
# Example: API_KEY=12345:abc123def456
# Get your key at: https://docs.ozon.ru/api/seller/#authentication
API_KEY=
```

---

## Definition of Done

- [ ] Security analyzer module created
- [ ] Guidance report generation working
- [ ] Required vs optional detection accurate
- [ ] .env.example includes all auth vars with comments
- [ ] README authentication section complete
- [ ] CLI displays security requirements
- [ ] Unsupported schemes flagged with workarounds
- [ ] All tests pass (≥80%)

---

## Success Criteria

1. ✅ Users understand auth requirements clearly
2. ✅ .env.example provides complete template
3. ✅ README has step-by-step auth setup
4. ✅ CLI shows security requirements
5. ✅ Tests verify all security configs
6. ✅ Ready for Interceptor Architecture (Story 4.7)

---

**Story Created:** 2025-01-04  
**Epic:** Epic 4  
**Story Number:** 4.6  
**Estimated Effort:** 4-5 hours
