# Story 4.3: Bearer Token Authentication Handler - Brownfield Addition

**Epic:** Epic 4: Authentication & Security Handlers

---

## User Story

**As a** generated MCP server,
**I want** to add Bearer Token authentication to requests,
**So that** I can access APIs that require JWT or OAuth2 bearer tokens.

---

## Story Context

**Existing System Integration:**

- Integrates with: HTTP client from Story 3.3, configuration from Story 4.1, API Key auth from Story 4.2
- Technology: Axios request interceptors, Bearer Token authentication (JWT)
- Follows pattern: Request interceptor pattern established in Story 4.2
- Touch points: HTTP client initialization, request preprocessing, configuration loading

**Epic Context:**

This story implements Bearer Token authentication, commonly used with JWT tokens and OAuth2. Following the same interceptor pattern as API Key auth (Story 4.2), this handler adds `Authorization: Bearer <token>` headers to requests.

**Project Context:**

Bearer Token authentication is standard for OAuth2 and JWT-based APIs. Many modern REST APIs use this method. The generated MCP server must automatically add bearer tokens to the Authorization header for all outgoing requests when the OpenAPI spec requires bearer authentication.

---

## Acceptance Criteria

### Functional Requirements

1. **Bearer Token Auth Module Creation**
   - Create auth module: `packages/templates/mcp-server/auth/bearer.ts.hbs`
   - Export `addBearerAuth()` function
   - Add `Authorization: Bearer <token>` header format
   - Type-safe implementation with TypeScript
   - Integration with configuration from Story 4.1

2. **Authorization Header Format**
   - Standard format: `Authorization: Bearer <token>`
   - Token value from `config.bearerToken`
   - Example: `Authorization: Bearer eyJhbGciOiJIUzI1NiIs...`
   - No additional encoding (token used as-is)

3. **Configuration Integration**
   - Load bearer token from configuration (Story 4.1)
   - Use `config.bearerToken` from `BEARER_TOKEN` env var
   - Validate token present if required
   - Error if missing: "Bearer Token authentication required but BEARER_TOKEN environment variable not set"

4. **JWT Format Validation (Optional)**
   - If `bearerFormat: JWT` in OpenAPI spec, basic validation
   - Check token has 3 base64-encoded parts separated by dots
   - Pattern: `xxx.yyy.zzz` (header.payload.signature)
   - Warning if format doesn't match (not error - may be non-JWT bearer)

5. **Request Interceptor Integration**
   - Integrate with Axios request interceptor
   - Apply bearer token to all outgoing requests automatically
   - Interceptor added during HTTP client initialization
   - Works alongside API Key auth (Story 4.2) if both required

6. **Token Refresh Placeholder**
   - Add comment placeholder for future token refresh logic
   - Document where token refresh would be implemented
   - Not implemented in this story (future enhancement)
   - Example comment: "// TODO: Implement token refresh logic here"

7. **Error Handling**
   - Throw clear error if bearer token required but not configured
   - Error includes: missing variable name, configuration instructions
   - Fail-fast during initialization
   - Example: "Missing required BEARER_TOKEN environment variable. Add BEARER_TOKEN=your-token-here to your .env file."

8. **Security: No Token Logging**
   - Never log bearer token values
   - Mask in debug output: `Bearer Token: ***hidden***`
   - Safe logging: confirm auth applied without showing token
   - Example debug log: "✓ Bearer Token authentication configured"

9. **Bearer Format Support**
   - Handle `bearerFormat: JWT` from OpenAPI spec
   - Include JWT format in documentation
   - Validate JWT structure if bearerFormat specified
   - Graceful handling of non-JWT bearer tokens

10. **Template Generation**
    - Generate bearer auth code based on OpenAPI `securitySchemes`
    - Detect `type: http, scheme: bearer` in security scheme
    - Extract `bearerFormat` if specified
    - No auth code generated if bearer auth not used

### Integration Requirements

11. **OpenAPI Security Scheme Detection**
    - Parse `securitySchemes` from OpenAPI (Story 2.6)
    - Identify bearer schemes: `type: http, scheme: bearer`
    - Extract `bearerFormat` (e.g., JWT)
    - Example:
      ```yaml
      securitySchemes:
        BearerAuth:
          type: http
          scheme: bearer
          bearerFormat: JWT
      ```

12. **HTTP Client Integration**
    - Register interceptor during HTTP client initialization
    - Interceptor modifies Authorization header
    - Compatible with API Key auth (Story 4.2)
    - Preserves existing headers

13. **Configuration System Integration**
    - Use `loadConfig()` from Story 4.1
    - Access `config.bearerToken` for credential
    - Validation ensures token present if required
    - Type-safe configuration access

### Quality Requirements

14. **Testing Coverage**
    - Unit test: Bearer token added to Authorization header
    - Unit test: JWT format validation works
    - Unit test: Error thrown if bearer token missing
    - Unit test: Bearer token never logged
    - Integration test: Request includes Authorization header
    - Integration test: Works with API Key auth (multi-auth)
    - Test coverage ≥80%

15. **Documentation Updates**
    - Document Bearer Token authentication in README
    - Explain how to configure BEARER_TOKEN
    - Include JWT token format explanation
    - Troubleshooting for auth failures
    - Link to OAuth2/JWT documentation

16. **Code Quality**
    - TypeScript strict mode compliance
    - No hardcoded tokens (security)
    - Clear error messages
    - JSDoc comments
    - Auth adds <5ms latency

---

## Technical Notes

### Integration Approach

**Bearer Token Auth Module:**
```typescript
// packages/templates/mcp-server/auth/bearer.ts.hbs
import type { InternalAxiosRequestConfig } from 'axios';
import type { ServerConfig } from '../config.js';

/**
 * Add Bearer Token authentication to request
 * Generated from OpenAPI securitySchemes
 */
export function addBearerAuth(
  config: InternalAxiosRequestConfig,
  serverConfig: ServerConfig
): InternalAxiosRequestConfig {
  const bearerToken = serverConfig.bearerToken;

  if (!bearerToken) {
    throw new Error(
      'Bearer Token authentication required but not configured. ' +
      'Please set BEARER_TOKEN in your .env file.'
    );
  }

  {{#if bearerFormat}}
  // Validate token format ({{bearerFormat}})
  {{#if (eq bearerFormat 'JWT')}}
  if (!isValidJWT(bearerToken)) {
    console.warn(
      'Warning: BEARER_TOKEN does not appear to be a valid JWT format. ' +
      'Expected format: header.payload.signature'
    );
  }
  {{/if}}
  {{/if}}

  // Add Authorization header
  config.headers['Authorization'] = `Bearer ${bearerToken}`;

  return config;
}

{{#if (eq bearerFormat 'JWT')}}
/**
 * Basic JWT format validation
 * Checks for 3 base64-encoded parts separated by dots
 */
function isValidJWT(token: string): boolean {
  const parts = token.split('.');
  return parts.length === 3 && parts.every(part => part.length > 0);
}
{{/if}}

/**
 * Validate Bearer Token configuration
 */
export function validateBearerConfig(config: ServerConfig): void {
  {{#if bearerRequired}}
  if (!config.bearerToken) {
    throw new Error(
      'Bearer Token authentication is required for this API.\n' +
      'Please set the BEARER_TOKEN environment variable in your .env file.\n' +
      'Example: BEARER_TOKEN=eyJhbGciOiJIUzI1NiIs...\n' +
      '\n' +
      'To obtain a bearer token, visit: {{bearerTokenDocUrl}}'
    );
  }
  {{/if}}
}

// Placeholder for future token refresh implementation
// TODO: Implement token refresh logic
// This would typically involve:
// 1. Detecting 401 responses
// 2. Calling refresh token endpoint
// 3. Updating stored token
// 4. Retrying failed request
```

**HTTP Client Integration:**
```typescript
// packages/templates/mcp-server/http-client.ts.hbs
import { addBearerAuth, validateBearerConfig } from './auth/bearer.js';

export function createHttpClient(config: ServerConfig): AxiosInstance {
  // Validate auth configuration
  {{#if hasBearerToken}}
  validateBearerConfig(config);
  {{/if}}

  const client = axios.create({
    baseURL: config.baseURL,
    timeout: config.timeout
  });

  client.interceptors.request.use(
    (requestConfig) => {
      {{#if hasApiKey}}
      requestConfig = addApiKeyAuth(requestConfig, config);
      {{/if}}
      {{#if hasBearerToken}}
      requestConfig = addBearerAuth(requestConfig, config);
      {{/if}}
      return requestConfig;
    }
  );

  return client;
}
```

**Enhanced .env.example:**
```bash
# Bearer Token Authentication
# Required: Yes
# Format: JWT (JSON Web Token)
# How to obtain: Visit https://api-docs.example.com/oauth
BEARER_TOKEN=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
```

### Dependencies

**Internal Dependencies:**
- Story 4.1: Configuration system
- Story 4.2: Auth pattern established
- Story 3.3: HTTP client
- Story 2.6: Security scheme extraction

---

## Definition of Done

- [ ] Bearer token auth module created
- [ ] `addBearerAuth()` implemented
- [ ] Authorization header format correct
- [ ] Configuration integration working
- [ ] JWT validation implemented (if bearerFormat: JWT)
- [ ] Request interceptor integration successful
- [ ] Token refresh placeholder added
- [ ] Error handling comprehensive
- [ ] Security: no token logging
- [ ] Template generation from OpenAPI
- [ ] All tests pass (≥80% coverage)
- [ ] Documentation complete
- [ ] Works with API Key auth (multi-auth)

---

## Success Criteria

1. ✅ Bearer token added to Authorization header automatically
2. ✅ JWT format validation working (if specified)
3. ✅ Configuration integration seamless
4. ✅ Compatible with API Key auth (Story 4.2)
5. ✅ Clear errors for missing configuration
6. ✅ Tokens never logged or exposed
7. ✅ Template generates correct code
8. ✅ Tests pass with 100% success rate
9. ✅ Documentation complete
10. ✅ Ready for Basic Auth (Story 4.4)

---

**Story Created:** 2025-01-04
**Epic:** Epic 4: Authentication & Security Handlers
**Story Number:** 4.3
**Estimated Effort:** 3-4 hours
