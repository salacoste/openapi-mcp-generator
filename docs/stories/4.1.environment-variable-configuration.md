# Story 4.1: Environment Variable Configuration System - Brownfield Addition

**Epic:** Epic 4: Authentication & Security Handlers

---

## User Story

**As a** generated MCP server,
**I want** a configuration system that loads API credentials from environment variables,
**So that** sensitive credentials are never hardcoded in the source code.

---

## Story Context

**Existing System Integration:**

- Integrates with: Generated MCP server from Epic 3, project scaffolding from Story 3.8
- Technology: Node.js environment variables, `dotenv` library, TypeScript
- Follows pattern: Secure configuration management, environment-based configuration
- Touch points: MCP server initialization (Story 3.4), HTTP client (Story 3.3), scaffolding (Story 3.8)

**Epic Context:**

This story establishes the foundation for all authentication in Epic 4. Before implementing specific auth handlers (API Key, Bearer, Basic), we need a secure, type-safe configuration system that loads credentials from environment variables. This prevents hardcoded secrets and follows security best practices.

**Project Context:**

Configuration management is critical for security. The generated MCP server must load API credentials from `.env` files without ever exposing secrets in code or version control. For the Ozon Performance API, this means securely managing API keys, bearer tokens, and other credentials while providing clear guidance to users on configuration.

---

## Acceptance Criteria

### Functional Requirements

1. **Configuration Module Creation**
   - Create configuration template: `packages/templates/mcp-server/config.ts.hbs`
   - Export `loadConfig()` function for initialization
   - Return typed configuration object
   - Support validation and error handling
   - Integrate with dotenv for `.env` file loading

2. **Configuration Interface Definition**
   - Define TypeScript interface for all config options:
     ```typescript
     interface ServerConfig {
       apiKey?: string;
       bearerToken?: string;
       basicAuth?: {
         username: string;
         password: string;
       };
       baseURL: string;
       timeout: number;
       debug: boolean;
       retryAttempts: number;
       retryDelay: number;
     }
     ```
   - Use optional fields for auth (not all APIs need all methods)
   - Required vs optional fields clearly typed
   - Default values for non-auth settings

3. **Environment Variable Mapping**
   - Map environment variables to config:
     - `API_KEY` → `config.apiKey`
     - `BEARER_TOKEN` → `config.bearerToken`
     - `BASIC_AUTH_USERNAME` → `config.basicAuth.username`
     - `BASIC_AUTH_PASSWORD` → `config.basicAuth.password`
     - `API_BASE_URL` → `config.baseURL`
     - `API_TIMEOUT` → `config.timeout`
     - `DEBUG` → `config.debug`
     - `RETRY_ATTEMPTS` → `config.retryAttempts`
     - `RETRY_DELAY` → `config.retryDelay`
   - Case-insensitive variable names
   - Support both uppercase and lowercase

4. **Configuration Validation**
   - Validate required auth credentials based on OpenAPI security schemes
   - Check `baseURL` is valid URL format
   - Validate `timeout` is positive integer
   - Validate `retryAttempts` is non-negative integer
   - Validate `debug` is boolean (true/false)
   - Throw clear errors for invalid configuration

5. **Default Values**
   - Provide sensible defaults:
     - `timeout`: 30000 (30 seconds)
     - `debug`: false
     - `retryAttempts`: 3
     - `retryDelay`: 1000 (1 second)
   - `baseURL`: from OpenAPI server URL (no default)
   - Auth credentials: no defaults (must be provided if required)

6. **Type Safety**
   - Full TypeScript types for all config options
   - No `any` types in configuration
   - Type guards for optional fields
   - Type-safe environment variable parsing

7. **.env.example Generation Enhancement**
   - Update Story 3.8 scaffolding to generate comprehensive `.env.example`
   - Include all configuration variables with descriptions
   - Example values for non-sensitive configs
   - Placeholder comments for auth credentials
   - Document required vs optional variables
   - Include recommended values and constraints

8. **Environment Variable Documentation**
   - Add configuration section to generated README
   - Document each environment variable:
     - Variable name
     - Required or optional
     - Type (string, number, boolean)
     - Default value (if any)
     - Example value
     - Description of purpose
   - Include troubleshooting for common config issues

9. **Configuration Error Handling**
   - Clear error messages for missing required credentials
   - Error: "Missing required API_KEY environment variable"
   - Error: "Invalid API_BASE_URL format, must be valid URL"
   - Error: "API_TIMEOUT must be positive number, got: [value]"
   - Include suggested fixes in error messages
   - Exit gracefully with helpful error (don't crash)

10. **Security: No Credential Logging**
    - Never log credential values (API keys, tokens, passwords)
    - Mask credentials in debug output: `API_KEY: ***hidden***`
    - Safe logging: log that credentials are loaded, not values
    - Sanitize error messages to avoid credential exposure

### Integration Requirements

11. **dotenv Integration**
    - Integrate `dotenv` library for `.env` file loading
    - Load `.env` at server startup (before any other code)
    - Support `.env.local` for local overrides (gitignored)
    - Graceful handling if `.env` file missing (use env vars)
    - Document `.env` file location and loading

12. **HTTP Client Integration**
    - Pass configuration to HTTP client (Story 3.3)
    - HTTP client uses `baseURL`, `timeout` from config
    - Auth credentials available for interceptors (Stories 4.2-4.4)
    - Configuration loaded before HTTP client initialization

13. **MCP Server Integration**
    - Load configuration at MCP server startup (Story 3.4)
    - Configuration available throughout server lifecycle
    - Server initialization fails fast if required config missing
    - Debug mode enables verbose logging in MCP server

### Quality Requirements

14. **Testing Coverage**
    - Unit test: `loadConfig()` with valid environment variables
    - Unit test: `loadConfig()` with missing required variables (error)
    - Unit test: `loadConfig()` with invalid values (validation errors)
    - Unit test: Default values applied correctly
    - Unit test: Environment variable mapping correct
    - Unit test: Type safety validation
    - Unit test: Credential masking in logs
    - Integration test: Config loads from `.env` file
    - Integration test: Server fails gracefully with missing config
    - Test coverage ≥80% for config module

15. **Documentation Updates**
    - Document configuration module in generator README
    - Add configuration guide for end users
    - Include troubleshooting section
    - Document security best practices
    - Add examples for different auth types

16. **Code Quality**
    - TypeScript strict mode compliance
    - No `any` types in configuration code
    - Clear error messages for all validation failures
    - Well-documented code with JSDoc comments
    - Configuration loads in <100ms

---

## Technical Notes

### Integration Approach

**Configuration Module:**
```typescript
// packages/templates/mcp-server/config.ts.hbs
import { config as loadEnv } from 'dotenv';
import { URL } from 'url';

export interface ServerConfig {
  // Authentication
  apiKey?: string;
  bearerToken?: string;
  basicAuth?: {
    username: string;
    password: string;
  };

  // API Configuration
  baseURL: string;
  timeout: number;
  debug: boolean;

  // Retry Configuration
  retryAttempts: number;
  retryDelay: number;
}

export interface SecurityRequirements {
  hasApiKey: boolean;
  hasBearerToken: boolean;
  hasBasicAuth: boolean;
  required: string[];
}

// Generated from OpenAPI security schemes
const SECURITY_REQUIREMENTS: SecurityRequirements = {
  hasApiKey: {{hasApiKey}},
  hasBearerToken: {{hasBearerToken}},
  hasBasicAuth: {{hasBasicAuth}},
  required: [{{#each requiredAuth}}'{{this}}'{{#unless @last}}, {{/unless}}{{/each}}]
};

export function loadConfig(): ServerConfig {
  // Load .env file
  loadEnv();

  // Parse environment variables
  const config: ServerConfig = {
    // Authentication
    apiKey: process.env.API_KEY,
    bearerToken: process.env.BEARER_TOKEN,
    basicAuth: parseBasicAuth(),

    // API Configuration
    baseURL: parseBaseURL(),
    timeout: parseTimeout(),
    debug: parseDebug(),

    // Retry Configuration
    retryAttempts: parseRetryAttempts(),
    retryDelay: parseRetryDelay()
  };

  // Validate configuration
  validateConfig(config);

  // Log configuration (without credentials)
  if (config.debug) {
    logConfig(config);
  }

  return config;
}

function parseBasicAuth(): { username: string; password: string } | undefined {
  const username = process.env.BASIC_AUTH_USERNAME;
  const password = process.env.BASIC_AUTH_PASSWORD;

  if (username && password) {
    return { username, password };
  }

  return undefined;
}

function parseBaseURL(): string {
  const baseURL = process.env.API_BASE_URL || '{{defaultBaseURL}}';

  if (!baseURL) {
    throw new Error(
      'Missing required API_BASE_URL environment variable. ' +
      'Please set API_BASE_URL in your .env file.'
    );
  }

  // Validate URL format
  try {
    new URL(baseURL);
  } catch (error) {
    throw new Error(
      `Invalid API_BASE_URL format: "${baseURL}". ` +
      'Must be a valid URL (e.g., https://api.example.com)'
    );
  }

  return baseURL;
}

function parseTimeout(): number {
  const timeout = process.env.API_TIMEOUT;

  if (!timeout) {
    return 30000; // Default: 30 seconds
  }

  const parsed = parseInt(timeout, 10);

  if (isNaN(parsed) || parsed <= 0) {
    throw new Error(
      `Invalid API_TIMEOUT value: "${timeout}". ` +
      'Must be a positive number in milliseconds (e.g., 30000)'
    );
  }

  return parsed;
}

function parseDebug(): boolean {
  const debug = process.env.DEBUG?.toLowerCase();
  return debug === 'true' || debug === '1' || debug === 'yes';
}

function parseRetryAttempts(): number {
  const retryAttempts = process.env.RETRY_ATTEMPTS;

  if (!retryAttempts) {
    return 3; // Default: 3 attempts
  }

  const parsed = parseInt(retryAttempts, 10);

  if (isNaN(parsed) || parsed < 0) {
    throw new Error(
      `Invalid RETRY_ATTEMPTS value: "${retryAttempts}". ` +
      'Must be a non-negative integer (e.g., 3)'
    );
  }

  return parsed;
}

function parseRetryDelay(): number {
  const retryDelay = process.env.RETRY_DELAY;

  if (!retryDelay) {
    return 1000; // Default: 1 second
  }

  const parsed = parseInt(retryDelay, 10);

  if (isNaN(parsed) || parsed < 0) {
    throw new Error(
      `Invalid RETRY_DELAY value: "${retryDelay}". ` +
      'Must be a non-negative integer in milliseconds (e.g., 1000)'
    );
  }

  return parsed;
}

function validateConfig(config: ServerConfig): void {
  const errors: string[] = [];

  // Validate required authentication credentials
  if (SECURITY_REQUIREMENTS.hasApiKey && !config.apiKey) {
    errors.push(
      'Missing required API_KEY environment variable. ' +
      'This API requires API Key authentication.'
    );
  }

  if (SECURITY_REQUIREMENTS.hasBearerToken && !config.bearerToken) {
    errors.push(
      'Missing required BEARER_TOKEN environment variable. ' +
      'This API requires Bearer Token authentication.'
    );
  }

  if (SECURITY_REQUIREMENTS.hasBasicAuth && !config.basicAuth) {
    errors.push(
      'Missing required BASIC_AUTH_USERNAME and BASIC_AUTH_PASSWORD environment variables. ' +
      'This API requires Basic Authentication.'
    );
  }

  if (errors.length > 0) {
    throw new Error(
      'Configuration validation failed:\n' +
      errors.map(e => `  - ${e}`).join('\n') +
      '\n\nPlease check your .env file and ensure all required credentials are set.'
    );
  }
}

function logConfig(config: ServerConfig): void {
  console.log('📋 Server Configuration:');
  console.log(`  Base URL: ${config.baseURL}`);
  console.log(`  Timeout: ${config.timeout}ms`);
  console.log(`  Debug: ${config.debug}`);
  console.log(`  Retry Attempts: ${config.retryAttempts}`);
  console.log(`  Retry Delay: ${config.retryDelay}ms`);

  // Mask credentials
  if (config.apiKey) {
    console.log('  API Key: ***hidden***');
  }
  if (config.bearerToken) {
    console.log('  Bearer Token: ***hidden***');
  }
  if (config.basicAuth) {
    console.log('  Basic Auth: ***hidden***');
  }
}
```

**Enhanced .env.example:**
```bash
# {{apiName}} MCP Server Configuration
# Copy this file to .env and configure your credentials

# =============================================================================
# API Configuration (Required)
# =============================================================================

# Base URL for the API
# Example: https://api-seller.ozon.ru
API_BASE_URL={{defaultBaseURL}}

# Request timeout in milliseconds (default: 30000)
API_TIMEOUT=30000

# =============================================================================
# Authentication Credentials
# =============================================================================
{{#if hasApiKey}}

# API Key Authentication
# Required: Yes
# Location: {{apiKeyLocation}} ({{apiKeyName}})
# Obtain your API key from: {{apiKeyDocUrl}}
API_KEY=your-api-key-here
{{/if}}
{{#if hasBearerToken}}

# Bearer Token Authentication
# Required: Yes
# Format: JWT token
# Obtain your token from: {{tokenDocUrl}}
BEARER_TOKEN=your-bearer-token-here
{{/if}}
{{#if hasBasicAuth}}

# Basic Authentication
# Required: Yes
# Provide your username and password
BASIC_AUTH_USERNAME=your-username
BASIC_AUTH_PASSWORD=your-password
{{/if}}

# =============================================================================
# Advanced Configuration (Optional)
# =============================================================================

# Enable debug mode for verbose logging (default: false)
# Values: true, false
DEBUG=false

# Number of retry attempts for failed requests (default: 3)
# Use 0 to disable retries
RETRY_ATTEMPTS=3

# Delay between retry attempts in milliseconds (default: 1000)
RETRY_DELAY=1000
```

**README Configuration Section:**
```markdown
## Configuration

This MCP server is configured using environment variables. Follow these steps to set up your configuration:

### 1. Create .env file

Copy the example environment file:

```bash
cp .env.example .env
```

### 2. Configure Required Variables

Edit `.env` and set the following **required** variables:

#### API_BASE_URL

The base URL for the {{apiName}} API.

- **Type:** String (URL)
- **Required:** Yes
- **Example:** `https://api-seller.ozon.ru`

```bash
API_BASE_URL=https://api-seller.ozon.ru
```
{{#if hasApiKey}}

#### API_KEY

Your API key for authentication.

- **Type:** String
- **Required:** Yes
- **Location:** {{apiKeyLocation}} header ({{apiKeyName}})
- **How to obtain:** See [API documentation]({{apiKeyDocUrl}})

```bash
API_KEY=your-api-key-here
```
{{/if}}

### 3. Configure Optional Variables (Advanced)

#### API_TIMEOUT

Request timeout in milliseconds.

- **Type:** Number
- **Required:** No
- **Default:** 30000 (30 seconds)
- **Range:** 1000 - 300000

```bash
API_TIMEOUT=30000
```

#### DEBUG

Enable verbose logging for debugging.

- **Type:** Boolean
- **Required:** No
- **Default:** false
- **Values:** `true`, `false`

```bash
DEBUG=true
```

#### RETRY_ATTEMPTS

Number of automatic retry attempts for failed requests.

- **Type:** Number
- **Required:** No
- **Default:** 3
- **Range:** 0 - 10

```bash
RETRY_ATTEMPTS=3
```

### Troubleshooting Configuration

**Error: "Missing required API_KEY environment variable"**

- Ensure `.env` file exists in the project root
- Verify `API_KEY` is set in `.env` file
- Check for typos in variable name (case-sensitive)

**Error: "Invalid API_BASE_URL format"**

- Ensure URL includes protocol (https://)
- Check for trailing slashes
- Verify URL is accessible

**Debug Mode**

Enable debug mode to see detailed configuration logs:

```bash
DEBUG=true npm start
```

This will show which configuration values are loaded (credentials are masked).
```

### Existing Pattern Reference

- **Scaffolding:** Story 3.8 `.env.example` generation
- **MCP Server:** Story 3.4 server initialization
- **HTTP Client:** Story 3.3 client configuration
- **Security Schemes:** Story 2.6 security extraction

### Key Constraints

- **No Breaking Changes:** Must integrate with existing Epic 3 code
- **Security:** Never log or expose credential values
- **Performance:** Configuration loads in <100ms
- **Usability:** Clear error messages for misconfigurations
- **Standards:** Follow 12-factor app configuration principles

### Dependencies

**External Libraries:**
- `dotenv`: ^16.3.0 (environment variable loading)

**Internal Dependencies:**
- Story 3.4: MCP server initialization
- Story 3.3: HTTP client configuration
- Story 3.8: Project scaffolding
- Story 2.6: Security scheme extraction

---

## Definition of Done

- [ ] Functional requirements 1-10 met
- [ ] Integration requirements 11-13 verified
- [ ] Configuration module created (`config.ts.hbs`)
- [ ] `loadConfig()` function implemented
- [ ] Configuration interface defined with full types
- [ ] Environment variable mapping working
- [ ] Configuration validation implemented
- [ ] Default values applied correctly
- [ ] Type safety verified (strict mode)
- [ ] .env.example enhanced with all variables
- [ ] README configuration section added
- [ ] Error handling comprehensive with clear messages
- [ ] Credential masking in logs implemented
- [ ] dotenv integration working
- [ ] HTTP client integration successful
- [ ] MCP server integration successful
- [ ] All tests pass (≥80% coverage)
- [ ] Documentation complete
- [ ] Tested with missing/invalid configurations
- [ ] Security verified (no credential exposure)

---

## Risk and Compatibility Check

### Minimal Risk Assessment

**Primary Risk:** Missing required credentials prevent server from starting

**Mitigation:**
- Clear validation errors with guidance
- .env.example provides complete template
- README documents all required variables
- Fail-fast approach prevents runtime errors
- Debug mode helps troubleshoot configuration

**Rollback:**
- Configuration is additive (doesn't break existing code)
- Can disable auth temporarily for testing
- Environment variables easy to modify
- No permanent state changes

### Compatibility Verification

- [ ] No breaking changes to Epic 3 code
- [ ] Database changes: N/A
- [ ] Backward compatible with existing MCP server
- [ ] Works with all Node.js versions ≥18

---

## Success Criteria

The story is successful when:

1. ✅ Configuration module loads environment variables securely
2. ✅ All auth credential types supported (API Key, Bearer, Basic)
3. ✅ Validation catches missing/invalid configuration
4. ✅ Default values applied for optional settings
5. ✅ Type safety enforced throughout
6. ✅ .env.example comprehensive and helpful
7. ✅ README configuration section clear and complete
8. ✅ Error messages actionable with suggested fixes
9. ✅ Credentials never logged or exposed
10. ✅ Integration with HTTP client and MCP server working
11. ✅ Tests pass with 100% success rate
12. ✅ Documentation complete
13. ✅ Ready for auth handler implementation (Stories 4.2-4.4)

---

**Story Created:** 2025-01-04
**Epic:** Epic 4: Authentication & Security Handlers
**Story Number:** 4.1
**Estimated Effort:** 4-6 hours
