# Story 1.2: CI/CD Pipeline with GitHub Actions

## Status

Approved

## Story

**As a** developer,
**I want** automated testing and build verification on every commit,
**so that** code quality is maintained and breaking changes are caught early.

## Acceptance Criteria

1. GitHub Actions workflow created for pull request validation
2. Workflow runs on Node.js 18, 20, 22 (LTS versions) in matrix
3. Workflow executes: `npm install`, TypeScript compilation (`tsc`), linting (`eslint`), unit tests
4. Workflow fails if any step fails (compilation errors, lint errors, test failures)
5. Workflow runs on macOS, Linux, Windows environments
6. Status checks required to pass before PR merge
7. Workflow caches `node_modules` for faster builds
8. Build status badge added to `README.md`

## Tasks / Subtasks

- [ ] Create GitHub Actions directory structure (AC: 1)
  - [ ] Create `.github/` directory at project root
  - [ ] Create `.github/workflows/` subdirectory
  - [ ] Verify directory structure exists

- [ ] Create pull request validation workflow (AC: 1, 2, 3, 4)
  - [ ] Create `.github/workflows/test.yml` file
  - [ ] Configure workflow trigger: `on: [pull_request, push]` to main/master branch
  - [ ] Define workflow name: "CI Pipeline"
  - [ ] Set up Node.js matrix strategy with versions: 18, 20, 22
  - [ ] Add checkout step: `actions/checkout@v4`
  - [ ] Add Node.js setup step: `actions/setup-node@v4` with matrix version
  - [ ] Add pnpm setup step: `pnpm/action-setup@v2` with version 8.15.1
  - [ ] Add pnpm install step: `pnpm install --frozen-lockfile`
  - [ ] Add TypeScript build step: `pnpm build` (or `tsc --noEmit` if no build script yet)
  - [ ] Add lint step: `pnpm lint`
  - [ ] Add test step: `pnpm test`
  - [ ] Ensure workflow fails if any step returns non-zero exit code

- [ ] Configure multi-OS testing matrix (AC: 5)
  - [ ] Add OS matrix to workflow strategy: `[ubuntu-latest, macos-latest, windows-latest]`
  - [ ] Verify matrix creates job combinations (3 Node versions Ã— 3 OS = 9 jobs)
  - [ ] Test workflow on each OS environment

- [ ] Implement node_modules caching (AC: 7)
  - [ ] Add pnpm cache configuration to workflow
  - [ ] Use `pnpm/action-setup@v2` built-in caching
  - [ ] Alternative: Add manual cache step with key: `${{ runner.os }}-pnpm-${{ hashFiles('**/pnpm-lock.yaml') }}`
  - [ ] Verify cache hit improves build time

- [ ] Configure branch protection rules (AC: 6)
  - [ ] Navigate to GitHub repository settings â†’ Branches
  - [ ] Add branch protection rule for `main` branch
  - [ ] Enable "Require status checks to pass before merging"
  - [ ] Select "CI Pipeline" workflow as required check
  - [ ] Enable "Require branches to be up to date before merging"
  - [ ] Document protection rule configuration in project docs

- [ ] Add build status badge to README (AC: 8)
  - [ ] Generate GitHub Actions badge URL: `https://github.com/{owner}/{repo}/actions/workflows/test.yml/badge.svg`
  - [ ] Add badge markdown to `README.md` at top of document
  - [ ] Format: `[![CI Pipeline](badge-url)](workflow-url)`
  - [ ] Verify badge displays correctly and updates with workflow status

- [ ] Create Dependabot configuration for automated dependency updates
  - [ ] Create `.github/dependabot.yml` file
  - [ ] Configure npm package ecosystem monitoring
  - [ ] Set update schedule to weekly
  - [ ] Configure version updates for production and dev dependencies
  - [ ] Set pull request limit to 5 concurrent PRs

- [ ] Test workflow execution (AC: 4)
  - [ ] Create test pull request to trigger workflow
  - [ ] Verify all matrix jobs execute successfully
  - [ ] Verify workflow fails if lint errors introduced (negative test)
  - [ ] Verify workflow fails if tests fail (negative test)
  - [ ] Verify workflow fails if TypeScript compilation fails (negative test)
  - [ ] Confirm status checks prevent merge when workflow fails

- [ ] Add workflow documentation
  - [ ] Document workflow purpose in `.github/workflows/test.yml` header comment
  - [ ] Add "CI/CD" section to `README.md` explaining automated checks
  - [ ] Document how to run checks locally before pushing
  - [ ] Add troubleshooting section for common CI failures

## Dev Notes

### CI/CD Pipeline Architecture
[Source: architecture/architecture-workflows.md#workflow-5-cicd-publishing-to-npm-registry]

The project uses **GitHub Actions** for continuous integration and deployment. The CI pipeline follows a **quality gate pattern** where all checks must pass before code can be merged or published.

**Pipeline Stages**:
1. Checkout code
2. Setup Node.js environment (matrix: 18, 20, 22)
3. Install dependencies with pnpm
4. Run tests (â‰¥80% coverage required)
5. Build packages (compile TypeScript)
6. Lint check (ESLint)
7. Type check (tsc --noEmit)

### Multi-Platform Testing Strategy
[Source: architecture/architecture.md#infrastructure-and-deployment]

**Testing Environments**: CI workflow runs on Node.js 18, 20, 22 (LTS versions) across macOS, Linux, Windows.

**Rationale**:
- Node.js 18: Minimum required for MCP SDK compatibility
- Node.js 20: Current LTS (stable through 2026)
- Node.js 22: Future LTS preparation
- Multi-OS: Ensure cross-platform compatibility for CLI tool

**Matrix Strategy**: Creates 9 parallel jobs (3 Node versions Ã— 3 operating systems) to catch platform-specific issues early.

### Quality Gates (Must Pass)
[Source: architecture/architecture-workflows.md#quality-gates-must-pass]

All CI checks are **blocking** - code cannot be merged if any fail:

1. âœ… All unit tests pass (â‰¥80% coverage)
2. âœ… TypeScript compilation succeeds (strict mode)
3. âœ… ESLint passes with no errors
4. âœ… pnpm build succeeds for all packages
5. âœ… Tests run on all OS/Node combinations

**Exit Code Policy**: Any step returning non-zero exit code fails the entire workflow.

### GitHub Actions Workflow Configuration
[Source: architecture/architecture-workflows.md#github-actions-workflow]

**Workflow File Location**: `.github/workflows/test.yml`

**Trigger Events**:
- `pull_request` - Runs on all PRs
- `push` - Runs on pushes to main/master branch

**Required Actions Versions**:
- `actions/checkout@v4` - Latest checkout action
- `actions/setup-node@v4` - Node.js environment setup
- `pnpm/action-setup@v2` - pnpm installation with caching

**pnpm Configuration**:
- Version: `8.15.1` (exact version from tech stack)
- Install flag: `--frozen-lockfile` (ensure reproducible builds, fail if lockfile changes needed)

### Caching Strategy
[Source: architecture/architecture-workflows.md#workflow-7]

**Cache Key**: `${{ runner.os }}-pnpm-${{ hashFiles('**/pnpm-lock.yaml') }}`

**Cache Benefits**:
- 50-70% faster builds on cache hit
- Reduces npm registry load
- Consistent dependency resolution

**Built-in Caching**: `pnpm/action-setup@v2` includes automatic node_modules caching - no manual cache step needed unless custom cache strategy required.

### Dependabot Configuration
[Source: architecture/architecture.md#security]

**Update Policy**:
- Critical/High vulnerabilities: Patch within 48h
- Medium vulnerabilities: Patch within 2 weeks
- Automated PR creation for dependency updates

**Dependabot Settings**:
- Ecosystem: npm
- Directory: "/"
- Schedule: weekly
- PR limit: 5 concurrent
- Assignees: maintainers

**Security Scanning**: npm audit runs automatically in CI to detect vulnerabilities.

### Branch Protection Requirements
[Source: architecture/architecture.md#infrastructure-and-deployment]

**Main Branch Protection Rules**:
- Require status checks before merge
- Require branches to be up to date
- Required check: "CI Pipeline" workflow
- No force push allowed
- No deletions allowed

**Rationale**: Prevents broken code from reaching main branch, ensures all changes pass quality gates.

### Workflow Performance Targets
[Source: architecture/architecture-workflows.md#performance-targets]

**CI Pipeline Timing**:
- Checkout: <10 seconds
- pnpm install (cached): <30 seconds
- pnpm install (no cache): <2 minutes
- Build: <1 minute
- Tests: <2 minutes
- Lint: <30 seconds
- Type check: <1 minute
- **Total (cached)**: <5 minutes
- **Total (no cache)**: <7 minutes

### Build Status Badge
[Source: architecture/architecture.md#infrastructure-and-deployment]

**Badge Format**: GitHub Actions provides automatic badge generation.

**Badge URL Template**:
```
https://github.com/{owner}/{repo}/actions/workflows/test.yml/badge.svg
```

**Markdown Format**:
```markdown
[![CI Pipeline](https://github.com/{owner}/{repo}/actions/workflows/test.yml/badge.svg)](https://github.com/{owner}/{repo}/actions/workflows/test.yml)
```

**Badge States**:
- ðŸŸ¢ Green: All checks passing
- ðŸ”´ Red: One or more checks failing
- ðŸŸ¡ Yellow: Workflow running
- âšª Gray: No workflow runs yet

### Error Handling and Notifications
[Source: architecture/architecture-workflows.md#rollback-strategy]

**Failure Notifications**:
- GitHub notifications on workflow failure
- Email to commit author
- Optional: Slack webhook integration

**Debugging Failed Workflows**:
1. Check workflow run logs in GitHub Actions tab
2. Identify failing step and error message
3. Reproduce locally: `pnpm install && pnpm test && pnpm lint && pnpm build`
4. Fix issue and push update

### Security Considerations
[Source: architecture/architecture.md#security]

**Secrets Management**:
- `NPM_TOKEN` - Used for publishing (Story 1.2 doesn't need this yet)
- `GITHUB_TOKEN` - Automatically provided by GitHub Actions

**No Secrets in Logs**: Workflow should never log environment variables or credentials.

**Dependency Security**:
- npm audit runs in CI
- Dependabot creates PRs for vulnerability fixes
- Exact version pinning prevents unexpected updates

### Testing

#### Testing Standards
[Source: architecture/architecture.md#test-strategy]

**Test Execution in CI**:
- Framework: Vitest 1.2.0
- Command: `pnpm test`
- Coverage requirement: â‰¥80% line coverage
- Parallel execution across packages

**Test Types in CI**:
- Unit tests: All packages (`packages/*/tests/`)
- Integration tests: Cross-package workflows (`tests/integration/`)
- E2E tests: Full CLI generation (added in later stories)

#### Story-Specific Testing Requirements

For this story, testing validation includes:

1. **Workflow Execution Test**: Create test PR to trigger workflow, verify all jobs pass
2. **Failure Detection Test**: Introduce deliberate errors to verify workflow catches them:
   - Add TypeScript error â†’ workflow should fail
   - Add ESLint violation â†’ workflow should fail
   - Break unit test â†’ workflow should fail
3. **Matrix Validation**: Verify all 9 job combinations (3 Node versions Ã— 3 OS) execute
4. **Cache Validation**: Second workflow run should show cache hit and faster install time
5. **Status Badge Test**: Badge should display in README and update with workflow status

**Acceptance**: All AC items verified through successful workflow execution and branch protection enforcement.

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-03 | 1.0 | Initial story creation | Bob (Scrum Master) |
| 2025-01-04 | 1.1 | Validation complete - no corrections needed, approved for implementation | Sarah (Product Owner) |

## Dev Agent Record

*This section will be populated by the development agent during implementation.*

### Agent Model Used

*To be completed by Dev Agent*

### Debug Log References

*To be completed by Dev Agent*

### Completion Notes List

*To be completed by Dev Agent*

### File List

*To be completed by Dev Agent*

## QA Results

*This section will be populated by QA Agent after story completion.*
