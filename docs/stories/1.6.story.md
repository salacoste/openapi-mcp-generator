# Story 1.6: Unit Testing Framework Setup

## Status

Approved

## Story

**As a** developer,
**I want** a testing framework configured for all packages,
**so that** I can write and run unit tests for code validation.

## Acceptance Criteria

1. Jest (or Vitest) installed as dev dependency at workspace root
2. Jest configuration file (`jest.config.js`) created with TypeScript support
3. Test script added to root `package.json`: `npm test` runs all package tests
4. Each package has `__tests__/` directory for test files
5. Example test file created for CLI command parsing (validates `generate` command registration)
6. Example test file created for file system utilities (validates directory creation, file writing)
7. Tests run successfully in CI/CD pipeline
8. Test coverage reporting configured (Istanbul/c8)
9. Coverage thresholds set: ≥80% for new code (enforced in CI)

## Tasks / Subtasks

- [ ] Assess current testing setup (AC: 1, 4, 5)
  - [ ] Check if Vitest is already installed at root
  - [ ] Review existing test files in packages/cli/__tests__/
  - [ ] Identify what's already working vs what needs configuration
  - [ ] Document current state in completion notes

- [ ] Install Vitest and coverage dependencies at root (AC: 1, 8)
  - [ ] Verify Vitest 1.2.0+ is in root package.json devDependencies
  - [ ] Add `@vitest/coverage-v8@1.2.0` for coverage reporting
  - [ ] Add `@vitest/ui@1.2.0` for visual test UI (optional)
  - [ ] Run `npm install` to install dependencies
  - [ ] Verify Vitest CLI is available: `npx vitest --version`

- [ ] Create root-level Vitest configuration (AC: 2)
  - [ ] Create `vitest.config.ts` at project root
  - [ ] Configure test matching: `test.include = ['packages/**/__tests__/**/*.test.ts']`
  - [ ] Configure TypeScript support: `esbuild` (built-in)
  - [ ] Enable coverage with v8 provider
  - [ ] Set coverage directory: `coverage.reportsDirectory = './coverage'`
  - [ ] Configure coverage reporters: `['text', 'lcov', 'html']`
  - [ ] Set globals: `test.globals = true` for describe/it without imports

- [ ] Configure coverage thresholds (AC: 9)
  - [ ] Set global thresholds: `coverage.thresholds.lines = 80`
  - [ ] Set function coverage: `coverage.thresholds.functions = 80`
  - [ ] Set branch coverage: `coverage.thresholds.branches = 70`
  - [ ] Set statement coverage: `coverage.thresholds.statements = 80`
  - [ ] Enable threshold enforcement: fail tests if below thresholds
  - [ ] Add package-specific thresholds for CLI (optional)

- [ ] Configure workspace support for monorepo (AC: 3, 4)
  - [ ] Add projects configuration: `test.projects = ['packages/*']`
  - [ ] Verify each package can run tests independently
  - [ ] Ensure workspace-level `npm test` runs all package tests
  - [ ] Test isolation: each package's tests run in separate environment

- [ ] Update root package.json test scripts (AC: 3)
  - [ ] Add test script: `"test": "vitest run"`
  - [ ] Add test:watch script: `"test:watch": "vitest"`
  - [ ] Add test:ui script: `"test:ui": "vitest --ui"`
  - [ ] Add coverage script: `"test:coverage": "vitest run --coverage"`
  - [ ] Verify scripts work: `npm test`, `npm run test:coverage`

- [ ] Verify existing CLI tests work with configuration (AC: 5)
  - [ ] Run CLI tests: `npm test --workspace=packages/cli`
  - [ ] Verify all 14 tests pass (from Story 1.3)
  - [ ] Check test output format and reporting
  - [ ] Verify no configuration conflicts

- [ ] Create example Generator tests (AC: 6) - If Story 1.4 implemented
  - [ ] Create `packages/generator/__tests__/fs-utils.test.ts` if not exists
  - [ ] Test: createDirectory creates directory with parents
  - [ ] Test: writeFile writes content with UTF-8 encoding
  - [ ] Test: copyTemplate copies directory recursively
  - [ ] Use temp directories for file system tests
  - [ ] Clean up test directories after each test
  - [ ] Run generator tests: `npm test --workspace=packages/generator`

- [ ] Create .gitignore entry for coverage (AC: 8)
  - [ ] Add `/coverage/` to root .gitignore
  - [ ] Add `.nyc_output/` (if using istanbul)
  - [ ] Verify coverage directory is not committed

- [ ] Create GitHub Actions CI test workflow (AC: 7)
  - [ ] Create or update `.github/workflows/test.yml`
  - [ ] Add test job with Node.js matrix (18, 20, 22)
  - [ ] Run `npm install` in workflow
  - [ ] Run `npm test` to execute all tests
  - [ ] Run `npm run test:coverage` to generate coverage
  - [ ] Upload coverage reports to Codecov or Coveralls (optional)
  - [ ] Fail workflow if coverage below thresholds

- [ ] Configure coverage reporting (AC: 8)
  - [ ] Enable HTML coverage report for local viewing
  - [ ] Enable LCOV report for CI integration
  - [ ] Enable text report for terminal output
  - [ ] Add coverage summary to test output
  - [ ] Document how to view coverage: `npm run test:coverage && open coverage/index.html`

- [ ] Document testing conventions (AC: 4, 5, 6)
  - [ ] Create `docs/testing.md` guide
  - [ ] Document test file naming: `*.test.ts`
  - [ ] Document test file location: `__tests__/` directory
  - [ ] Document test patterns: AAA (Arrange, Act, Assert)
  - [ ] Document mocking strategies
  - [ ] Add examples of unit vs integration tests
  - [ ] Link to Vitest documentation

- [ ] Validate coverage thresholds enforcement (AC: 9)
  - [ ] Intentionally lower test coverage temporarily
  - [ ] Run tests and verify threshold failure
  - [ ] Restore test coverage
  - [ ] Verify tests pass again
  - [ ] Document threshold enforcement in testing guide

- [ ] Update root README with testing instructions (AC: 3)
  - [ ] Add "Testing" section to README
  - [ ] Document test commands: `npm test`, `npm run test:coverage`
  - [ ] Document how to run package-specific tests
  - [ ] Document coverage threshold requirements
  - [ ] Add testing badge (optional)

## Dev Notes

### Current Testing State Assessment
[Source: Story 1.3 completion context]

**Already Implemented**:
- ✅ Vitest installed in root package.json devDependencies
- ✅ CLI package has `__tests__/cli.test.ts` with 14 passing tests
- ✅ Tests use proper patterns: describe, it, expect, beforeEach, afterEach
- ✅ Mocking with vi.spyOn for process.exit and console.error

**What This Story Adds**:
- Root-level Vitest configuration for workspace coordination
- Coverage reporting with thresholds
- CI/CD integration
- Documentation and testing conventions
- Validation that framework works for all packages

### Vitest Architecture and Configuration
[Source: Context7 - /vitest-dev/vitest]

**Why Vitest over Jest**:
[Source: docs/architecture/architecture.md#tech-stack]
1. **Native ESM Support**: Works seamlessly with `"type": "module"`
2. **Performance**: 2-5x faster than Jest with instant HMR
3. **Vite Integration**: Built on Vite for fast builds
4. **Jest Compatible**: Drop-in replacement with similar API
5. **TypeScript First**: Built-in TypeScript support, no ts-jest needed

**Vitest Version**: `vitest@1.2.0` (from architecture spec)

### Root Vitest Configuration Pattern
[Source: Context7 - /vitest-dev/vitest configuration examples]

**Basic Configuration** (`vitest.config.ts`):
```typescript
import { defineConfig } from 'vitest/config';

export default defineConfig({
  test: {
    // Test file patterns
    include: ['packages/**/__tests__/**/*.test.ts'],

    // Global test APIs (describe, it, expect without imports)
    globals: true,

    // Coverage configuration
    coverage: {
      provider: 'v8',  // Fast built-in coverage
      reporter: ['text', 'lcov', 'html'],
      reportsDirectory: './coverage',

      // Coverage thresholds
      thresholds: {
        lines: 80,
        functions: 80,
        branches: 70,
        statements: 80
      },

      // Files to include in coverage
      include: ['packages/**/src/**/*.ts'],

      // Files to exclude from coverage
      exclude: [
        '**/node_modules/**',
        '**/dist/**',
        '**/__tests__/**',
        '**/types.ts'
      ]
    },

    // Workspace support for monorepo
    projects: ['packages/*']
  }
});
```

**Coverage Provider Options**:
1. **v8** (Recommended): Fast, built-in, works with ESM
2. **istanbul**: More accurate, requires `@vitest/coverage-istanbul`

**For this project**: Use v8 for speed and ESM compatibility

### Workspace Configuration for Monorepo
[Source: Context7 - /vitest-dev/vitest workspace examples]

**Why Workspace Mode**:
- Runs tests for multiple packages in parallel
- Each package can have its own configuration
- Unified test reporting
- Workspace-level coverage aggregation

**Projects Array Pattern**:
```typescript
export default defineConfig({
  test: {
    // Run tests for all packages
    projects: ['packages/*'],

    // Or specify individual packages
    // projects: ['packages/cli', 'packages/generator', 'packages/templates']
  }
});
```

**Per-Package Overrides** (Optional):
```typescript
// packages/cli/vitest.config.ts (if needed)
import { defineConfig } from 'vitest/config';

export default defineConfig({
  test: {
    // Package-specific test configuration
    coverage: {
      thresholds: {
        lines: 90  // Higher threshold for CLI
      }
    }
  }
});
```

### Coverage Reporting Configuration
[Source: Context7 - /vitest-dev/vitest coverage examples]

**Multiple Reporters Pattern**:
```typescript
coverage: {
  reporter: [
    'text',           // Terminal output during tests
    'lcov',           // For CI/Codecov integration
    'html',           // For local viewing (open coverage/index.html)
    ['json', { file: 'coverage.json' }]  // Machine-readable
  ]
}
```

**Coverage Include/Exclude Strategy**:
```typescript
coverage: {
  // Include source files
  include: ['packages/**/src/**/*.{ts,tsx}'],

  // Exclude from coverage
  exclude: [
    '**/node_modules/**',
    '**/dist/**',
    '**/__tests__/**',
    '**/types.ts',           // Type definition files
    '**/index.ts',           // Simple re-exports
    '**/*.config.ts',        // Configuration files
    '**/mocks/**'            // Test mocks
  ]
}
```

### Test File Organization
[Source: docs/architecture/architecture.md#test-strategy]

**Directory Structure**:
```
packages/
├── cli/
│   ├── src/
│   │   ├── index.ts
│   │   ├── commands/
│   │   └── utils/
│   └── __tests__/
│       ├── cli.test.ts         # Unit tests
│       └── e2e/
│           └── generate.test.ts # E2E tests
├── generator/
│   ├── src/
│   │   └── fs-utils.ts
│   └── __tests__/
│       └── fs-utils.test.ts
└── parser/
    ├── src/
    └── __tests__/
```

**Test File Naming**:
- Unit tests: `<filename>.test.ts`
- Integration tests: `<feature>.integration.test.ts`
- E2E tests: `<scenario>.e2e.test.ts`

**Test Pattern** (AAA):
```typescript
describe('Feature Name', () => {
  // Arrange
  beforeEach(() => {
    // Setup test environment
  });

  // Act + Assert
  it('should do something specific', () => {
    // Arrange (test-specific setup)
    const input = 'test';

    // Act
    const result = myFunction(input);

    // Assert
    expect(result).toBe('expected');
  });

  // Cleanup
  afterEach(() => {
    // Restore mocks, clean up resources
  });
});
```

### GitHub Actions CI Integration
[Source: Story 1.2 context - CI/CD Pipeline]

**Test Workflow** (`.github/workflows/test.yml`):
```yaml
name: Test

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  test:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        node: [18, 20, 22]
        os: [ubuntu-latest, macos-latest, windows-latest]

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run tests
        run: npm test

      - name: Run tests with coverage
        run: npm run test:coverage

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          file: ./coverage/lcov.info
```

### Coverage Threshold Enforcement
[Source: Context7 - /vitest-dev/vitest coverage examples]

**How Thresholds Work**:
1. Vitest runs tests and collects coverage
2. Compares actual coverage to thresholds
3. Fails test run if below thresholds
4. Displays detailed coverage report

**Threshold Configuration**:
```typescript
coverage: {
  thresholds: {
    lines: 80,        // 80% of lines must be covered
    functions: 80,    // 80% of functions called
    branches: 70,     // 70% of branches taken
    statements: 80    // 80% of statements executed
  }
}
```

**Per-Package Thresholds** (Optional):
```typescript
coverage: {
  thresholds: {
    // Global defaults
    lines: 80,

    // Specific package overrides
    'packages/cli/src/**': {
      lines: 90,      // Higher bar for CLI
      functions: 90
    },
    'packages/generator/src/**': {
      lines: 85
    }
  }
}
```

### Previous Story Context

**Story 1.3 Completion** (Done):
- CLI package with 14 passing Vitest tests
- Tests use: describe, it, expect, vi.spyOn
- Mock patterns: process.exit, console.error
- Test file: `packages/cli/__tests__/cli.test.ts`

**Story 1.4 Context** (Draft):
- Generator package with fs-utils functions
- Test plan: real file system with temp directories
- Expected tests: createDirectory, writeFile, copyTemplate
- Test file: `packages/generator/__tests__/fs-utils.test.ts`

**Story 1.5 Context** (Draft):
- Templates package (mostly static files)
- E2E test plan: generate → build → run
- Test file: `packages/cli/__tests__/e2e/generate.test.ts`

**Key Takeaway**: Testing infrastructure partially exists. This story formalizes it with root-level configuration, coverage, and CI integration.

### File Locations

**Files to Create**:
- `vitest.config.ts` (root level)
- `.github/workflows/test.yml` (or update existing)
- `docs/testing.md` (testing guide)
- `packages/generator/__tests__/fs-utils.test.ts` (if not created in Story 1.4)

**Files to Modify**:
- Root `package.json` (add test scripts)
- Root `.gitignore` (add /coverage/)
- Root `README.md` (add testing section)

**Files Already Exist**:
- `packages/cli/__tests__/cli.test.ts` (Story 1.3)

**Project Structure Alignment**:
[Source: docs/architecture/architecture.md#source-tree]

```
openapi-to-mcp/
├── .github/
│   └── workflows/
│       └── test.yml          # CI test workflow
├── packages/
│   ├── cli/
│   │   └── __tests__/        # ✅ Already exists (Story 1.3)
│   │       └── cli.test.ts
│   ├── generator/
│   │   └── __tests__/        # Story 1.4
│   │       └── fs-utils.test.ts
│   └── templates/            # Minimal tests (static files)
├── docs/
│   └── testing.md            # THIS STORY
├── coverage/                 # Generated (gitignored)
├── vitest.config.ts          # THIS STORY
└── package.json
```

## Testing

### Testing Standards
[Source: docs/architecture/architecture.md#test-strategy]

**Test Framework**: Vitest 1.2.0
**Coverage Target**: ≥80% line coverage (enforced)

**Test Execution**:
```bash
# Run all tests
npm test

# Run with coverage
npm run test:coverage

# Watch mode
npm run test:watch

# Visual UI
npm run test:ui

# Package-specific tests
npm test --workspace=packages/cli
```

### Story-Specific Testing Requirements

This story is meta - it sets up the testing framework. Testing validation includes:

1. **Configuration Validation**:
   - Vitest config loads without errors
   - Workspace projects detected correctly
   - Coverage configuration valid

2. **Existing Tests Pass**:
   - CLI tests (14 tests from Story 1.3) pass
   - Generator tests pass (if Story 1.4 implemented)
   - No test failures from configuration changes

3. **Coverage Reporting Works**:
   - HTML coverage report generated
   - LCOV coverage report generated
   - Text coverage displayed in terminal
   - Coverage directory created

4. **Threshold Enforcement**:
   - Tests fail when coverage below 80%
   - Tests pass when coverage above 80%
   - Per-package thresholds work (if configured)

5. **CI Integration**:
   - GitHub Actions workflow runs tests
   - Tests run on Node 18, 20, 22
   - Coverage uploaded to CI
   - Workflow fails on test failures

**Acceptance**:
- All existing tests pass with new configuration
- Coverage report generated successfully
- Coverage thresholds enforced
- CI workflow runs tests successfully

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-03 | 1.0 | Initial story creation | Bob (Scrum Master) |
| 2025-01-04 | 1.1 | Validation complete - no corrections needed, approved for development | Sarah (Product Owner) |

## Dev Agent Record

*This section will be populated by the development agent during implementation.*

### Agent Model Used

*To be completed by Dev Agent*

### Debug Log References

*To be completed by Dev Agent*

### Completion Notes List

*To be completed by Dev Agent*

### File List

*To be completed by Dev Agent*

## QA Results

*This section will be populated by QA Agent after story completion.*
