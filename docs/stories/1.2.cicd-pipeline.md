# Story 1.2: CI/CD Pipeline with GitHub Actions

## Status

**Draft**

---

## Story

**As a** developer,
**I want** automated testing and build verification on every commit,
**so that** code quality is maintained and breaking changes are caught early.

---

## Acceptance Criteria

1. GitHub Actions workflow created for pull request validation
2. Workflow runs on Node.js 18, 20, 22 (LTS versions) in matrix
3. Workflow executes: `npm install`, TypeScript compilation (`tsc`), linting (`eslint`), unit tests
4. Workflow fails if any step fails (compilation errors, lint errors, test failures)
5. Workflow runs on macOS, Linux, Windows environments
6. Status checks required to pass before PR merge
7. Workflow caches `node_modules` for faster builds
8. Build status badge added to `README.md`

---

## Tasks / Subtasks

- [ ] **Task 1: Create GitHub Actions Workflow Directory** (AC: 1)
  - [ ] Create `.github/workflows/` directory structure
  - [ ] Verify directory permissions and accessibility
  - [ ] Create placeholder for workflow files

- [ ] **Task 2: Create Test Workflow for Pull Requests** (AC: 1, 2, 3, 4)
  - [ ] Create `.github/workflows/test.yml` workflow file
  - [ ] Configure workflow trigger: on pull_request and push to main
  - [ ] Set up Node.js matrix strategy with versions: 18, 20, 22
  - [ ] Add `actions/checkout@v4` step to checkout code
  - [ ] Add `actions/setup-node@v4` step with matrix Node version
  - [ ] Add `pnpm/action-setup@v2` step with version 8.15.1
  - [ ] Configure pnpm install with frozen lockfile
  - [ ] Add TypeScript compilation step: `pnpm -r exec tsc --noEmit`
  - [ ] Add linting step: `pnpm run lint`
  - [ ] Add testing step: `pnpm test`
  - [ ] Verify workflow syntax with GitHub Actions validator

- [ ] **Task 3: Configure Multi-OS Testing Matrix** (AC: 5)
  - [ ] Extend workflow matrix to include: `ubuntu-latest`, `macos-latest`, `windows-latest`
  - [ ] Test matrix combinations: 3 Node versions × 3 OS = 9 jobs
  - [ ] Handle OS-specific path differences if needed
  - [ ] Verify workflow runs successfully on all matrix combinations

- [ ] **Task 4: Implement Dependency Caching** (AC: 7)
  - [ ] Add `actions/cache@v4` step for pnpm store
  - [ ] Configure cache key: `pnpm-${{ runner.os }}-${{ hashFiles('**/pnpm-lock.yaml') }}`
  - [ ] Configure restore keys for cache fallback
  - [ ] Measure build time improvement with caching enabled
  - [ ] Verify cache hits on subsequent workflow runs

- [ ] **Task 5: Configure Branch Protection Rules** (AC: 6)
  - [ ] Navigate to repository Settings → Branches → Add rule
  - [ ] Set branch name pattern: `main`
  - [ ] Enable "Require status checks to pass before merging"
  - [ ] Select required checks: `test (18, ubuntu-latest)`, `test (20, ubuntu-latest)`, `test (22, ubuntu-latest)`
  - [ ] Enable "Require branches to be up to date before merging"
  - [ ] Verify PR merge is blocked when checks fail

- [ ] **Task 6: Add Build Status Badge to README** (AC: 8)
  - [ ] Generate GitHub Actions badge URL: `https://github.com/{owner}/{repo}/actions/workflows/test.yml/badge.svg`
  - [ ] Add badge to top of `README.md` using markdown format
  - [ ] Verify badge displays correctly and links to workflow runs
  - [ ] Commit and push changes to test badge functionality

- [ ] **Task 7: Test Complete CI/CD Pipeline** (AC: 1-8)
  - [ ] Create test branch and make a sample code change
  - [ ] Open pull request to trigger workflow
  - [ ] Verify all matrix jobs run (9 total: 3 Node × 3 OS)
  - [ ] Verify workflow steps execute in correct order
  - [ ] Intentionally introduce lint error and verify workflow fails
  - [ ] Fix error and verify workflow passes
  - [ ] Merge PR and verify main branch protection works

---

## Dev Notes

### Previous Story Insights

**From Story 1.1 (Project Repository Setup):**
- Monorepo structure with 4 packages: `packages/cli/`, `packages/parser/`, `packages/generator/`, `packages/templates/`
- Package manager: pnpm 8.15.1
- TypeScript 5.3.3 with strict mode enabled
- ESLint 8.56.0 and Prettier 3.2.4 configured
- Vitest 1.2.0 for testing

**Key Integration Points:**
- CI/CD must work with pnpm workspace commands (`pnpm -r` for recursive operations)
- Tests use `pnpm test` script configured in root package.json
- Linting uses `pnpm run lint` script
- TypeScript compilation: `pnpm -r exec tsc --noEmit`

---

### Architecture Context

This story implements automated CI/CD pipeline to ensure code quality and catch breaking changes early in the development process.

**[Source: docs/architecture/architecture-workflows.md#workflow-5-cicd-publishing]**

---

### GitHub Actions Workflow Architecture

**Workflow Structure:**
```
Developer → Push/PR → GitHub → Trigger Workflow → Matrix Jobs (Node 18/20/22 × macOS/Linux/Windows)
  → Checkout → Setup Node → Install pnpm → Cache → Install deps → Test → Build → Lint → Type check
  → ✅ Success or ❌ Failure
```

**Quality Gates (Must Pass):**
1. ✅ All unit tests pass (≥80% coverage)
2. ✅ TypeScript compilation succeeds
3. ✅ ESLint passes with no errors
4. ✅ pnpm install succeeds

**[Source: docs/architecture/architecture-workflows.md#workflow-5-cicd-publishing]**

---

### CI/CD Configuration from Architecture

**Node.js Versions to Test:**
- Node.js 18 (minimum - MCP SDK requirement)
- Node.js 20.11.0 LTS (primary development version)
- Node.js 22 (latest LTS)

**Operating Systems:**
- `ubuntu-latest` - Primary CI environment
- `macos-latest` - macOS compatibility validation
- `windows-latest` - Windows compatibility validation

**Build Pipeline Steps:**
1. Checkout code
2. Setup Node.js (matrix version)
3. Setup pnpm 8.15.1
4. Install dependencies (`pnpm install --frozen-lockfile`)
5. Run tests (`pnpm test`)
6. Build packages (`pnpm build` - if build script exists)
7. Lint (`pnpm lint`)
8. Type check (`tsc --noEmit`)

**[Source: docs/architecture/architecture.md#infrastructure-and-deployment]**

---

### GitHub Actions Workflow Example (from Architecture)

**Complete Test Workflow Template:**

```yaml
# .github/workflows/test.yml
name: Test

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]

jobs:
  test:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        node: [18, 20, 22]
        os: [ubuntu-latest, macos-latest, windows-latest]

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js ${{ matrix.node }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node }}

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8.15.1

      - name: Get pnpm store directory
        shell: bash
        run: echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

      - name: Setup pnpm cache
        uses: actions/cache@v4
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run tests
        run: pnpm test

      - name: Lint
        run: pnpm run lint

      - name: Type check
        run: pnpm -r exec tsc --noEmit
```

**[Source: docs/architecture/architecture-workflows.md#github-actions-workflow]**

---

### Context7 Code Examples: GitHub Actions Best Practices

#### Matrix Build Configuration

**Multi-Environment Testing Pattern:**
```yaml
on: push

jobs:
  build:
    strategy:
      matrix:
        node: [18, 20, 22]
        os: [ubuntu-latest, macos-latest, windows-latest]
    runs-on: ${{ matrix.os }}
    steps:
    - uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node }}
    - run: npm install
    - run: npm test
```

**[Source: Context7 /actions/toolkit - Multi-Environment Node.js Testing]**

**Why This Pattern:**
- Tests across all LTS Node.js versions (18, 20, 22)
- Validates cross-platform compatibility early
- Catches OS-specific bugs before production
- Aligns with MCP SDK requirement (Node ≥18)

---

#### Checkout Action Configuration

**Basic Checkout with Full History:**
```yaml
steps:
  - uses: actions/checkout@v4
    with:
      fetch-depth: 0  # Fetch all history for all branches
```

**Standard PR Checkout (Recommended for CI):**
```yaml
- uses: actions/checkout@v4
  # Uses default: fetch-depth: 1 (shallow clone)
  # Automatically checks out PR head commit
```

**[Source: Context7 /actions/checkout - Checkout Action Usage]**

**For This Story:**
- Use default checkout (shallow clone) - faster for CI
- No need for full history in test workflow
- Checkout automatically handles PR refs correctly

---

#### Caching Strategy

**pnpm Store Caching Pattern:**
```yaml
- name: Get pnpm store directory
  shell: bash
  run: echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

- name: Setup pnpm cache
  uses: actions/cache@v4
  with:
    path: ${{ env.STORE_PATH }}
    key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
    restore-keys: |
      ${{ runner.os }}-pnpm-store-
```

**[Source: Context7 /actions/toolkit - Caching Dependencies]**

**Cache Performance:**
- First run: ~60s install time (no cache)
- Subsequent runs: ~10s install time (cache hit)
- 80-85% time reduction on dependency installation
- Cache key changes when pnpm-lock.yaml changes

---

#### Workflow Triggers

**Pull Request and Push Triggers:**
```yaml
on:
  pull_request:
    branches: [main]
    types: [opened, synchronize, closed]
  push:
    branches: [main]
```

**[Source: Context7 /actions/checkout - PR Event Triggers]**

**For This Story:**
- `pull_request` on `main`: Runs for all PRs targeting main
- `push` to `main`: Runs after PR merge for protection
- `types: [opened, synchronize]`: Runs on PR create and update

---

#### Environment Variables and Secrets

**Setting Environment Variables:**
```bash
# Simple variable
echo "FOO=BAR" >> $GITHUB_ENV

# Multiline variable (heredoc syntax)
echo 'JSON_RESPONSE<<EOF' >> $GITHUB_ENV
curl https://api.example.com/data >> $GITHUB_ENV
echo 'EOF' >> $GITHUB_ENV
```

**[Source: Context7 /actions/toolkit - Environment Variables]**

**For This Story:**
- No secrets required (public test workflow)
- Use GITHUB_ENV for dynamic path variables (pnpm store path)
- Future: NPM_TOKEN will be needed for publish workflow (Story in Epic 8)

---

#### Error Handling and Status Reporting

**Fail Fast vs Continue on Error:**
```yaml
jobs:
  test:
    strategy:
      fail-fast: false  # Continue running other matrix jobs even if one fails
      matrix:
        node: [18, 20, 22]
```

**Masking Secrets in Logs:**
```bash
echo "::add-mask::mysecretvalue"
# Now 'mysecretvalue' will appear as *** in logs
```

**Log Levels:**
```bash
echo "::debug::My debug message"
echo "::notice::My notice message"
echo "::warning::My warning message"
echo "::error::My error message"
```

**[Source: Context7 /actions/toolkit - Logging and Error Handling]**

---

### Branch Protection Configuration

**Required Settings:**
- **Branch name pattern:** `main`
- **Require status checks to pass:** Enabled
- **Required checks:** Select specific matrix jobs (recommend ubuntu-latest for all Node versions)
- **Require branches to be up to date:** Enabled
- **Require linear history:** Optional (recommended)

**Status Check Selection:**
- Minimum: `test (18, ubuntu-latest)`, `test (20, ubuntu-latest)`, `test (22, ubuntu-latest)`
- Comprehensive: All 9 matrix combinations (if needed)

**[Source: docs/architecture/architecture-workflows.md#quality-gates]**

---

### Build Status Badge

**Badge Markdown Format:**
```markdown
[![Test](https://github.com/{owner}/{repo}/actions/workflows/test.yml/badge.svg)](https://github.com/{owner}/{repo}/actions/workflows/test.yml)
```

**Badge Placement:**
- Add to README.md immediately after title
- Provides visual CI status indicator
- Links to workflow runs for transparency

---

### Workflow Performance Targets

**Performance Expectations:**
- **Cold run (no cache):** <3 minutes total workflow time
- **Warm run (with cache):** <2 minutes total workflow time
- **Cache hit rate:** >90% after initial run
- **Parallel execution:** All 9 matrix jobs run concurrently

**[Source: docs/architecture/architecture-workflows.md#performance-targets]**

---

### Project Structure Notes

**Required Files Created:**
```
.github/
  workflows/
    test.yml          # Main CI workflow
```

**Modified Files:**
```
README.md             # Add build status badge
```

**No Conflicts Identified** - Epic acceptance criteria align with architecture requirements.

---

### Testing

#### Testing Standards

**CI/CD Testing Requirements:**

**Workflow Validation:**
- Workflow syntax must be valid YAML
- All required steps must execute successfully
- Matrix combinations must complete without errors
- Cache must improve performance (measure time difference)

**Test Coverage Requirements:**
- This story tests the CI infrastructure itself
- No application code coverage (covered by Story 1.6)
- Validation: Workflow runs successfully end-to-end

**Acceptance Testing:**
1. **Positive Test:** Clean PR merge with all checks passing
2. **Negative Test:** PR blocked when lint/test fails
3. **Cache Test:** Second run completes faster than first
4. **Cross-Platform:** All 9 matrix jobs succeed

**[Source: docs/architecture/architecture.md#test-strategy]**

---

### Coding Standards

**YAML Formatting:**
- 2-space indentation (standard YAML convention)
- Consistent key ordering: name, on, jobs, steps
- Use explicit step names for clarity
- Prefer `shell: bash` for cross-platform commands

**GitHub Actions Best Practices:**
1. **Pin action versions:** Use `@v4` not `@latest` for stability
2. **Fail fast:** Set `fail-fast: false` for matrix to see all failures
3. **Use caching:** Always cache dependencies when possible
4. **Explicit names:** Every step should have descriptive `name:` field
5. **Security:** Never hardcode secrets, use `${{ secrets.SECRET_NAME }}`

**[Source: Context7 /actions/toolkit - Action Versioning and Best Practices]**

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-03 | 1.0 | Initial story creation with Context7 integration | Bob (Scrum Master) |

---

## Dev Agent Record

*This section will be populated by the development agent during implementation.*

### Agent Model Used

*To be filled by Dev Agent*

### Debug Log References

*To be filled by Dev Agent*

### Completion Notes List

*To be filled by Dev Agent*

### File List

*To be filled by Dev Agent*

---

## QA Results

*This section will be populated by QA Agent after story completion.*
