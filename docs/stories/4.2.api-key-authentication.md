# Story 4.2: API Key Authentication Handler - Brownfield Addition

**Epic:** Epic 4: Authentication & Security Handlers

---

## User Story

**As a** generated MCP server,
**I want** to add API Key authentication to requests,
**So that** I can access APIs that require API Key auth.

---

## Story Context

**Existing System Integration:**

- Integrates with: HTTP client from Story 3.3, configuration from Story 4.1
- Technology: Axios request interceptors, API Key authentication
- Follows pattern: Request interceptor pattern, authentication handler
- Touch points: HTTP client initialization, request preprocessing, configuration loading

**Epic Context:**

This story implements the first authentication handler for API Key authentication. Building on the configuration system (Story 4.1), we create an auth handler that automatically adds API keys to requests via headers, query parameters, or cookies based on OpenAPI security scheme definitions.

**Project Context:**

API Key authentication is one of the most common auth methods for REST APIs. The Ozon Performance API uses API Key authentication via headers (Client-Id and Api-Key). This story generates code that automatically adds API keys to all outgoing requests based on the OpenAPI specification's security configuration.

---

## Acceptance Criteria

### Functional Requirements

1. **API Key Auth Module Creation**
   - Create auth module: `packages/templates/mcp-server/auth/api-key.ts.hbs`
   - Export `addApiKeyAuth()` function
   - Support header, query parameter, and cookie locations
   - Type-safe implementation with TypeScript
   - Integration with configuration from Story 4.1

2. **Header-Based API Key**
   - Add API key to request headers
   - Header name from OpenAPI `securitySchemes` (e.g., `X-API-Key`, `Authorization`)
   - Format: `headerName: apiKeyValue`
   - Example: `X-API-Key: abc123def456`
   - Support custom header names from OpenAPI spec

3. **Query Parameter API Key**
   - Add API key to URL query parameters
   - Parameter name from OpenAPI `securitySchemes` (e.g., `api_key`, `key`)
   - Format: `?paramName=apiKeyValue`
   - Example: `https://api.example.com/users?api_key=abc123`
   - Proper URL encoding for special characters

4. **Cookie-Based API Key**
   - Add API key to `Cookie` header
   - Cookie name from OpenAPI `securitySchemes`
   - Format: `Cookie: cookieName=apiKeyValue`
   - Example: `Cookie: api_key=abc123`
   - Support multiple cookies (append to existing)

5. **Configuration Integration**
   - Load API key from configuration (Story 4.1)
   - Use `config.apiKey` from environment variable
   - Validate API key present if required
   - Error if API key missing: "API Key authentication required but API_KEY environment variable not set"

6. **Request Interceptor Integration**
   - Integrate with Axios request interceptor
   - Apply API key to all outgoing requests automatically
   - Interceptor added during HTTP client initialization
   - No manual auth code needed in tool handlers

7. **Multi-Key Support (Optional)**
   - Support multiple API keys if OpenAPI defines multiple schemes
   - Example: `Client-Id` and `Api-Key` headers (Ozon API)
   - Both keys applied to requests
   - Configuration: `API_KEY_1`, `API_KEY_2` or structured config

8. **Error Handling**
   - Throw clear error if API key required but not configured
   - Error includes: missing variable name, configuration instructions
   - Fail-fast during initialization (before any requests)
   - Example: "Missing required API_KEY environment variable. Add API_KEY=your-key-here to your .env file."

9. **Security: No Logging**
   - Never log API key values
   - Mask in debug output: `API Key: ***hidden***`
   - Safe logging: confirm auth applied without showing value
   - Example debug log: "✓ API Key authentication configured"

10. **Template Generation**
    - Generate API key auth code based on OpenAPI `securitySchemes`
    - Detect `type: apiKey` in security scheme
    - Extract `name` and `in` properties
    - Generate appropriate auth code for location (header/query/cookie)
    - No auth code generated if API key not used

### Integration Requirements

11. **OpenAPI Security Scheme Detection**
    - Parse `securitySchemes` from OpenAPI document (Story 2.6)
    - Identify API key schemes: `type: apiKey`
    - Extract metadata: `name` (param/header name), `in` (location)
    - Support global and operation-level security
    - Example:
      ```yaml
      securitySchemes:
        ApiKeyAuth:
          type: apiKey
          in: header
          name: X-API-Key
      ```

12. **HTTP Client Integration**
    - Register interceptor during HTTP client initialization (Story 3.3)
    - Interceptor modifies request config before sending
    - Works with all request methods (GET, POST, PUT, DELETE, etc.)
    - Preserves existing headers/params/cookies

13. **Configuration System Integration**
    - Use `loadConfig()` from Story 4.1
    - Access `config.apiKey` for credential
    - Validation during config load ensures API key present
    - Type-safe access to configuration

### Quality Requirements

14. **Testing Coverage**
    - Unit test: Header-based API key added correctly
    - Unit test: Query parameter API key added correctly
    - Unit test: Cookie-based API key added correctly
    - Unit test: Multiple API keys handled correctly (if applicable)
    - Unit test: Error thrown if API key missing
    - Unit test: API key never logged (security test)
    - Integration test: Request includes API key header
    - Integration test: API request succeeds with valid key
    - Integration test: API request fails with missing key
    - Test coverage ≥80% for API key auth module

15. **Documentation Updates**
    - Document API key authentication in generated README
    - Explain how to configure API_KEY environment variable
    - Include example for header, query, and cookie locations
    - Troubleshooting section for auth failures
    - Link to API documentation for obtaining keys

16. **Code Quality**
    - TypeScript strict mode compliance
    - No hardcoded API keys (security)
    - Clear error messages for all failure scenarios
    - Well-documented code with JSDoc comments
    - Auth application adds <5ms latency to requests

---

## Technical Notes

### Integration Approach

**API Key Auth Module:**
```typescript
// packages/templates/mcp-server/auth/api-key.ts.hbs
import type { InternalAxiosRequestConfig } from 'axios';
import type { ServerConfig } from '../config.js';

export interface ApiKeyConfig {
  name: string;
  in: 'header' | 'query' | 'cookie';
  value: string;
}

/**
 * Add API Key authentication to request
 * Generated from OpenAPI securitySchemes
 */
export function addApiKeyAuth(
  config: InternalAxiosRequestConfig,
  serverConfig: ServerConfig
): InternalAxiosRequestConfig {
  const apiKey = serverConfig.apiKey;

  if (!apiKey) {
    throw new Error(
      'API Key authentication required but not configured. ' +
      'Please set API_KEY in your .env file.'
    );
  }

  {{#if apiKeySchemes}}
  {{#each apiKeySchemes}}
  // {{description}}
  // Security Scheme: {{schemeName}}
  {{#if (eq in 'header')}}
  // Add API key to header: {{name}}
  config.headers['{{name}}'] = apiKey;
  {{/if}}
  {{#if (eq in 'query')}}
  // Add API key to query parameter: {{name}}
  if (!config.params) {
    config.params = {};
  }
  config.params['{{name}}'] = apiKey;
  {{/if}}
  {{#if (eq in 'cookie')}}
  // Add API key to cookie: {{name}}
  const existingCookie = config.headers['Cookie'] || '';
  const newCookie = existingCookie
    ? `${existingCookie}; {{name}}=${apiKey}`
    : `{{name}}=${apiKey}`;
  config.headers['Cookie'] = newCookie;
  {{/if}}
  {{/each}}
  {{/if}}

  return config;
}

/**
 * Validate API Key configuration
 * Throws error if required API key is missing
 */
export function validateApiKeyConfig(config: ServerConfig): void {
  {{#if apiKeyRequired}}
  if (!config.apiKey) {
    throw new Error(
      'API Key authentication is required for this API.\n' +
      'Please set the API_KEY environment variable in your .env file.\n' +
      'Example: API_KEY=your-api-key-here\n' +
      '\n' +
      'To obtain an API key, visit: {{apiKeyDocUrl}}'
    );
  }
  {{/if}}
}
```

**HTTP Client Integration:**
```typescript
// packages/templates/mcp-server/http-client.ts.hbs
import axios, { type AxiosInstance, type InternalAxiosRequestConfig } from 'axios';
import type { ServerConfig } from './config.js';
import { addApiKeyAuth, validateApiKeyConfig } from './auth/api-key.js';

export function createHttpClient(config: ServerConfig): AxiosInstance {
  // Validate auth configuration
  {{#if hasApiKey}}
  validateApiKeyConfig(config);
  {{/if}}

  // Create Axios instance
  const client = axios.create({
    baseURL: config.baseURL,
    timeout: config.timeout,
    headers: {
      'Content-Type': 'application/json',
      'User-Agent': '{{apiName}}-MCP-Server/{{version}}'
    }
  });

  // Add request interceptor for authentication
  client.interceptors.request.use(
    (requestConfig: InternalAxiosRequestConfig) => {
      {{#if hasApiKey}}
      // Apply API Key authentication
      requestConfig = addApiKeyAuth(requestConfig, config);
      {{/if}}

      if (config.debug) {
        console.log(`→ ${requestConfig.method?.toUpperCase()} ${requestConfig.url}`);
      }

      return requestConfig;
    },
    (error) => {
      return Promise.reject(error);
    }
  );

  return client;
}
```

**Ozon API Example (Multiple API Keys):**
```typescript
// Generated for Ozon Performance API
// Ozon uses Client-Id and Api-Key headers

export function addApiKeyAuth(
  config: InternalAxiosRequestConfig,
  serverConfig: ServerConfig
): InternalAxiosRequestConfig {
  // Ozon requires both Client-Id and Api-Key headers
  if (!serverConfig.apiKey) {
    throw new Error(
      'API Key authentication required but not configured. ' +
      'Please set API_KEY in your .env file.'
    );
  }

  // Parse API key (format: "Client-Id:Api-Key")
  const [clientId, apiKey] = serverConfig.apiKey.split(':');

  if (!clientId || !apiKey) {
    throw new Error(
      'Invalid API_KEY format for Ozon API. ' +
      'Expected format: "Client-Id:Api-Key" ' +
      'Example: API_KEY=12345:abc123def456'
    );
  }

  // Add Client-Id header
  config.headers['Client-Id'] = clientId;

  // Add Api-Key header
  config.headers['Api-Key'] = apiKey;

  return config;
}
```

**Enhanced .env.example:**
```bash
# API Key Authentication
# Required: Yes
# Location: Header (X-API-Key)
# How to obtain: Visit https://api-docs.example.com/authentication
API_KEY=your-api-key-here

# For Ozon Performance API (dual keys):
# Format: Client-Id:Api-Key
# Example: API_KEY=12345:abc123def456
```

**README Authentication Section:**
```markdown
## Authentication

This MCP server uses **API Key authentication** to access the {{apiName}} API.

### API Key Configuration

1. **Obtain an API Key**

   Visit the [API documentation]({{apiKeyDocUrl}}) to create an API key.

2. **Configure the API Key**

   Add your API key to the `.env` file:

   ```bash
   API_KEY=your-api-key-here
   ```

   {{#if isOzonApi}}
   **Note for Ozon API:** Ozon requires both Client-Id and Api-Key. Use the format:
   ```bash
   API_KEY=Client-Id:Api-Key
   ```
   Example:
   ```bash
   API_KEY=12345:abc123def456
   ```
   {{/if}}

3. **Verify Configuration**

   Start the server with debug mode to verify the API key is configured:

   ```bash
   DEBUG=true npm start
   ```

   You should see: `✓ API Key authentication configured`

### How It Works

The API key is automatically added to all API requests as:

{{#if (eq apiKeyLocation 'header')}}
- **Header:** `{{apiKeyName}}: your-api-key-here`
{{/if}}
{{#if (eq apiKeyLocation 'query')}}
- **Query Parameter:** `?{{apiKeyName}}=your-api-key-here`
{{/if}}
{{#if (eq apiKeyLocation 'cookie')}}
- **Cookie:** `{{apiKeyName}}=your-api-key-here`
{{/if}}

No additional configuration is needed. The auth handler applies the API key to all requests automatically.

### Troubleshooting

**Error: "API Key authentication required but not configured"**

- Ensure `.env` file exists with `API_KEY` set
- Check for typos in variable name (case-sensitive)
- Verify no extra spaces around the API key value

**Error: "401 Unauthorized" from API**

- Verify your API key is valid and active
- Check API key has necessary permissions
- Ensure API key is not expired

**Security Note**

Never commit your `.env` file or share your API key publicly. The `.gitignore` file prevents `.env` from being committed.
```

### Existing Pattern Reference

- **HTTP Client:** Story 3.3 Axios client and interceptors
- **Configuration:** Story 4.1 config loading and validation
- **Security Extraction:** Story 2.6 OpenAPI security schemes
- **Template Engine:** Story 3.1 code generation

### Key Constraints

- **No Breaking Changes:** Must integrate with existing HTTP client
- **Security:** Never log API key values
- **Performance:** Auth adds <5ms latency per request
- **Flexibility:** Support header, query, and cookie locations
- **Standards:** Follow OpenAPI 3.0 security scheme spec

### Dependencies

**External Libraries:**
- `axios`: ^1.6.0 (HTTP client with interceptors)

**Internal Dependencies:**
- Story 4.1: Configuration system
- Story 3.3: HTTP client
- Story 2.6: Security scheme extraction
- Story 3.1: Template engine

---

## Definition of Done

- [ ] Functional requirements 1-10 met
- [ ] Integration requirements 11-13 verified
- [ ] API key auth module created (`auth/api-key.ts.hbs`)
- [ ] `addApiKeyAuth()` function implemented
- [ ] Header-based API key working
- [ ] Query parameter API key working
- [ ] Cookie-based API key working
- [ ] Configuration integration complete
- [ ] Request interceptor integration successful
- [ ] Multi-key support (if needed for Ozon)
- [ ] Error handling comprehensive
- [ ] Security: no API key logging verified
- [ ] Template generation based on OpenAPI
- [ ] HTTP client integration working
- [ ] All tests pass (≥80% coverage)
- [ ] Documentation complete (README, auth section)
- [ ] Tested with Ozon Performance API
- [ ] Security audit passed

---

## Risk and Compatibility Check

### Minimal Risk Assessment

**Primary Risk:** API key exposed in logs or errors

**Mitigation:**
- Never log API key values (masking implemented)
- Sanitize error messages
- Code review focuses on security
- Automated tests verify no logging
- Security audit before completion

**Rollback:**
- Can disable API key auth by removing from config
- No permanent state changes
- Easy to modify or remove interceptor

### Compatibility Verification

- [ ] No breaking changes to existing HTTP client
- [ ] Works with all request methods (GET, POST, etc.)
- [ ] Compatible with other interceptors
- [ ] Backward compatible with Epic 3 code

---

## Success Criteria

The story is successful when:

1. ✅ API key added to requests automatically
2. ✅ Header, query, and cookie locations supported
3. ✅ Configuration integration working seamlessly
4. ✅ Interceptor applies auth without manual code
5. ✅ Multi-key support for Ozon API working
6. ✅ Clear errors for missing/invalid configuration
7. ✅ API keys never logged or exposed
8. ✅ Template generates correct code from OpenAPI
9. ✅ Tests pass with 100% success rate
10. ✅ Documentation clear and complete
11. ✅ Ozon API authentication working
12. ✅ Ready for Bearer Token auth (Story 4.3)

---

**Story Created:** 2025-01-04
**Epic:** Epic 4: Authentication & Security Handlers
**Story Number:** 4.2
**Estimated Effort:** 4-6 hours
